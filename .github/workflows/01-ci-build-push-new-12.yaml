# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CI/CD Pipeline - new-12
# Build, push to ECR, update manifests, and deploy via ArgoCD
# Generated by Opsera Code-to-Cloud Enterprise v0.912
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: "01-CI/CD new-12"

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'Dockerfile'
      - 'nginx.conf'
      - 'index.html'
      - 'tailwind.config.ts'
      - 'tsconfig*.json'
  workflow_dispatch:
    inputs:
      skip_security:
        description: 'Skip security scanning'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  APP_NAME: new-12
  TENANT: opsera
  AWS_REGION: us-west-2
  ECR_REPOSITORY: opsera/new-12
  ARGOCD_SERVER: argocd-usw2.agent.opsera.dev
  ARGOCD_APP: new-12-dev

concurrency:
  group: ci-new-12-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 1: Security Scanning (Gitleaks)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-scan:
    name: "Security Scan"
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_security != 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 2: Verify Bootstrap Complete
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-bootstrap:
    name: "Verify Bootstrap"
    runs-on: ubuntu-latest
    outputs:
      ecr_uri: ${{ steps.ecr-check.outputs.ecr_uri }}
      image_tag: ${{ steps.generate-tag.outputs.image_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check ECR repository exists
        id: ecr-check
        run: |
          ECR_URI="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}"
          echo "ecr_uri=${ECR_URI}" >> $GITHUB_OUTPUT
          
          if ! aws ecr describe-repositories --repository-names "${{ env.ECR_REPOSITORY }}" 2>/dev/null; then
            echo "âŒ ECR repository not found. Please run bootstrap workflow first."
            exit 1
          fi
          echo "âœ… ECR repository verified: ${ECR_URI}"

      - name: Generate image tag
        id: generate-tag
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          IMAGE_TAG="${TIMESTAMP}-${SHORT_SHA}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Image tag: ${IMAGE_TAG}"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 3: Build and Push Docker Image
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-and-push:
    name: "Build & Push"
    runs-on: ubuntu-latest
    needs: [security-scan, verify-bootstrap]
    if: always() && (needs.security-scan.result == 'success' || needs.security-scan.result == 'skipped') && needs.verify-bootstrap.result == 'success'
    outputs:
      image_uri: ${{ steps.build.outputs.image_uri }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ needs.verify-bootstrap.outputs.ecr_uri }}:${{ needs.verify-bootstrap.outputs.image_tag }}
            ${{ needs.verify-bootstrap.outputs.ecr_uri }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image URI
        run: |
          IMAGE_URI="${{ needs.verify-bootstrap.outputs.ecr_uri }}:${{ needs.verify-bootstrap.outputs.image_tag }}"
          echo "image_uri=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "ğŸ³ Image pushed: ${IMAGE_URI}"

      - name: Run Grype vulnerability scan
        continue-on-error: true
        run: |
          echo "ğŸ” Running Grype vulnerability scan..."
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          grype ${{ needs.verify-bootstrap.outputs.ecr_uri }}:${{ needs.verify-bootstrap.outputs.image_tag }} --fail-on critical || true
          echo "âœ… Vulnerability scan complete"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 4: Update Kubernetes Manifests
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-manifests:
    name: "Update Manifests"
    runs-on: ubuntu-latest
    needs: [verify-bootstrap, build-and-push]
    if: needs.build-and-push.result == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest changes
        run: git pull origin main

      - name: Update Kustomization image tag
        run: |
          ECR_URI="${{ needs.verify-bootstrap.outputs.ecr_uri }}"
          IMAGE_TAG="${{ needs.verify-bootstrap.outputs.image_tag }}"
          
          echo "ğŸ”§ Updating image tag to: ${IMAGE_TAG}"
          
          cd .opsera-new-12/k8s/overlays/dev
          
          # Update using kustomize edit or sed
          if command -v kustomize &> /dev/null; then
            kustomize edit set image ${ECR_URI}:latest=${ECR_URI}:${IMAGE_TAG}
          else
            sed -i "s|newTag:.*|newTag: ${IMAGE_TAG}|g" kustomization.yaml
          fi
          
          echo "âœ… Manifest updated"

      - name: Commit manifest updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          if git diff --staged --quiet; then
            echo "ğŸ“ No changes to commit"
          else
            git commit -m "chore(deploy): Update new-12-dev image to ${{ needs.verify-bootstrap.outputs.image_tag }} [skip ci]"
            git push
            echo "âœ… Manifest committed"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 5: Sync and Deploy via ArgoCD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sync-and-deploy:
    name: "Deploy"
    runs-on: ubuntu-latest
    needs: [verify-bootstrap, build-and-push, update-manifests]
    if: needs.update-manifests.result == 'success'
    steps:
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: Login to ArgoCD
        run: |
          argocd login ${{ env.ARGOCD_SERVER }} \
            --username admin \
            --password "${{ secrets.ARGOCD_ADMIN_PASSWORD }}" \
            --grpc-web \
            --insecure

      - name: Sync ArgoCD Application
        run: |
          echo "ğŸš€ Triggering ArgoCD sync for: ${{ env.ARGOCD_APP }}"
          
          # Force refresh and sync
          argocd app get ${{ env.ARGOCD_APP }} --refresh
          argocd app sync ${{ env.ARGOCD_APP }} --prune --force
          
          echo "â³ Waiting for deployment to complete..."
          argocd app wait ${{ env.ARGOCD_APP }} --timeout 300 --health
          
          echo "âœ… Deployment complete"

      - name: Verify deployment health
        run: |
          echo "ğŸ¥ Verifying deployment health..."
          argocd app get ${{ env.ARGOCD_APP }}
          
          STATUS=$(argocd app get ${{ env.ARGOCD_APP }} -o json | jq -r '.status.health.status')
          if [[ "$STATUS" == "Healthy" ]]; then
            echo "âœ… Application is healthy!"
          else
            echo "âš ï¸ Application health status: $STATUS"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 6: Summary
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: "Pipeline Summary"
    runs-on: ubuntu-latest
    needs: [security-scan, verify-bootstrap, build-and-push, update-manifests, sync-and-deploy]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                     CI/CD SUMMARY - new-12                                   â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Security Scan:     ${{ needs.security-scan.result }}"
          echo "â•‘  Verify Bootstrap:  ${{ needs.verify-bootstrap.result }}"
          echo "â•‘  Build & Push:      ${{ needs.build-and-push.result }}"
          echo "â•‘  Update Manifests:  ${{ needs.update-manifests.result }}"
          echo "â•‘  Deploy:            ${{ needs.sync-and-deploy.result }}"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Image Tag: ${{ needs.verify-bootstrap.outputs.image_tag }}"
          echo "â•‘  ECR URI: ${{ needs.verify-bootstrap.outputs.ecr_uri }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [[ "${{ needs.sync-and-deploy.result }}" == "success" ]]; then
            echo ""
            echo "âœ… Deployment successful!"
            echo "ğŸŒ Application: https://opsera-new-12-dev.agent.opsera.dev"
          else
            echo ""
            echo "âš ï¸  Pipeline completed with issues. Check job logs."
          fi
