# ════════════════════════════════════════════════════════════════════════════
# BOOTSTRAP WORKFLOW - new-13
# Generated by Opsera Code-to-Cloud Enterprise v0.913
# 
# RULE 93: Uses kubectl with EKS authentication (NOT ArgoCD CLI)
# RULE 147: Gets ECR URI dynamically to avoid secret masking
# RULE 148: Explicit permissions for git operations
# ════════════════════════════════════════════════════════════════════════════
name: "00-Bootstrap new-13"

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "bootstrap" to confirm'
        required: true
        default: 'bootstrap'

# RULE 148: Required permissions for git push and AWS OIDC
permissions:
  contents: write
  id-token: write

env:
  APP_NAME: new-13
  TENANT: opsera
  AWS_REGION: us-west-2
  ECR_REPOSITORY: opsera/new-13
  HUB_CLUSTER_NAME: argocd-usw2
  SPOKE_CLUSTER_NAME: opsera-usw2-np
  ARGOCD_SERVER: argocd-usw2.agent.opsera.dev

jobs:
  # ──────────────────────────────────────────────────────────────────────────
  # Job 1: Setup ECR Repository
  # ──────────────────────────────────────────────────────────────────────────
  setup-ecr:
    name: "Setup ECR Repository"
    runs-on: ubuntu-latest
    outputs:
      ecr_created: ${{ steps.create-ecr.outputs.created }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create ECR repository if not exists
        id: create-ecr
        run: |
          if aws ecr describe-repositories --repository-names "${{ env.ECR_REPOSITORY }}" 2>/dev/null; then
            echo "ECR repository already exists"
            echo "created=false" >> $GITHUB_OUTPUT
          else
            aws ecr create-repository \
              --repository-name "${{ env.ECR_REPOSITORY }}" \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=AES256
            echo "ECR repository created"
            echo "created=true" >> $GITHUB_OUTPUT
          fi

  # ──────────────────────────────────────────────────────────────────────────
  # Job 2: Update Configuration (RULE 147: Dynamic ECR URI)
  # ──────────────────────────────────────────────────────────────────────────
  update-config:
    name: "Update Configuration"
    runs-on: ubuntu-latest
    needs: [setup-ecr]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update placeholders
        run: |
          # RULE 147: Get AWS Account ID dynamically to avoid secret masking
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}"
          REPO_URL="${{ github.server_url }}/${{ github.repository }}.git"
          
          echo "ECR URI: ${ECR_URI}"
          echo "Repo URL: ${REPO_URL}"
          
          # Update ArgoCD application with repo URL
          sed -i "s|PLACEHOLDER_REPO_URL|${REPO_URL}|g" .opsera-${{ env.APP_NAME }}/argocd/dev/application.yaml
          
          # Update deployment with ECR URI
          sed -i "s|PLACEHOLDER_ECR_URI|${ECR_URI}|g" .opsera-${{ env.APP_NAME }}/k8s/base/deployment.yaml
          
          # Update kustomization with ECR URI for image transformer
          sed -i "s|PLACEHOLDER_ECR_URI|${ECR_URI}|g" .opsera-${{ env.APP_NAME }}/k8s/overlays/dev/kustomization.yaml

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: bootstrap new-13 - update ECR and repo placeholders"
            git push
          fi

  # ──────────────────────────────────────────────────────────────────────────
  # Job 3: Create ECR Pull Secret (RULE 93: kubectl, not ArgoCD CLI)
  # ──────────────────────────────────────────────────────────────────────────
  create-ecr-secret:
    name: "Create ECR Pull Secret"
    runs-on: ubuntu-latest
    needs: [update-config]
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl for spoke cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.TENANT }}-${{ env.APP_NAME }}-dev --dry-run=client -o yaml | kubectl apply -f -

      - name: Create ECR pull secret
        run: |
          # Get ECR login token
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_TOKEN=$(aws ecr get-login-password --region ${{ env.AWS_REGION }})
          ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          
          # Delete existing secret if exists
          kubectl delete secret ecr-credentials -n ${{ env.TENANT }}-${{ env.APP_NAME }}-dev --ignore-not-found
          
          # Create docker-registry secret
          kubectl create secret docker-registry ecr-credentials \
            --namespace=${{ env.TENANT }}-${{ env.APP_NAME }}-dev \
            --docker-server=${ECR_REGISTRY} \
            --docker-username=AWS \
            --docker-password=${ECR_TOKEN}
          
          echo "ECR pull secret created in namespace ${{ env.TENANT }}-${{ env.APP_NAME }}-dev"

  # ──────────────────────────────────────────────────────────────────────────
  # Job 4: Register Repository with ArgoCD (RULE 93: kubectl)
  # ──────────────────────────────────────────────────────────────────────────
  register-repo:
    name: "Register Repository with ArgoCD"
    runs-on: ubuntu-latest
    needs: [create-ecr-secret]
    continue-on-error: true
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl for hub cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Check if repo secret exists
        id: check-repo
        run: |
          if kubectl get secret repo-${{ env.APP_NAME }} -n argocd 2>/dev/null; then
            echo "Repository secret already exists"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Repository secret does not exist"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create repository secret
        if: steps.check-repo.outputs.exists != 'true'
        run: |
          REPO_URL="${{ github.server_url }}/${{ github.repository }}.git"
          
          kubectl create secret generic repo-${{ env.APP_NAME }} \
            --namespace=argocd \
            --from-literal=type=git \
            --from-literal=url=${REPO_URL} \
            --from-literal=name=${{ env.APP_NAME }}
          
          kubectl label secret repo-${{ env.APP_NAME }} -n argocd \
            argocd.argoproj.io/secret-type=repository

  # ──────────────────────────────────────────────────────────────────────────
  # Job 5: Apply ArgoCD Application (RULE 93: kubectl, not ArgoCD CLI)
  # ──────────────────────────────────────────────────────────────────────────
  apply-argocd-app:
    name: "Apply ArgoCD Application"
    runs-on: ubuntu-latest
    needs: [register-repo]
    if: always() && needs.register-repo.result != 'cancelled'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl for hub cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Pull latest changes
        run: |
          git pull origin main

      - name: Apply ArgoCD application
        run: |
          kubectl apply -f .opsera-${{ env.APP_NAME }}/argocd/dev/application.yaml
          echo "ArgoCD application applied successfully"

      - name: Trigger initial sync
        run: |
          # Annotate to trigger refresh
          kubectl annotate application ${{ env.APP_NAME }}-dev -n argocd \
            argocd.argoproj.io/refresh=hard --overwrite || true
          
          echo "Initial sync triggered for ${{ env.APP_NAME }}-dev"

  # ──────────────────────────────────────────────────────────────────────────
  # Job 6: Summary
  # ──────────────────────────────────────────────────────────────────────────
  summary:
    name: "Bootstrap Summary"
    runs-on: ubuntu-latest
    needs: [setup-ecr, update-config, create-ecr-secret, register-repo, apply-argocd-app]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║              BOOTSTRAP COMPLETE - new-13                         ║"
          echo "╠══════════════════════════════════════════════════════════════════╣"
          echo "║  ECR Setup:        ${{ needs.setup-ecr.result }}"
          echo "║  Config Update:    ${{ needs.update-config.result }}"
          echo "║  ECR Secret:       ${{ needs.create-ecr-secret.result }}"
          echo "║  Repo Register:    ${{ needs.register-repo.result }}"
          echo "║  ArgoCD App:       ${{ needs.apply-argocd-app.result }}"
          echo "╠══════════════════════════════════════════════════════════════════╣"
          echo "║  Next Step: Run 01-ci-build-push-new-13 workflow                 ║"
          echo "╚══════════════════════════════════════════════════════════════════╝"
