# ════════════════════════════════════════════════════════════════════════════
# Fix Ingress - healthcp-test-0219
# Gets events, describes ingress, patches with annotation, forces reload.
# ════════════════════════════════════════════════════════════════════════════

name: "Fix Ingress - healthcp-test-0219"

on:
  workflow_dispatch: {}

env:
  APP_NAME: healthcp-test-0219
  TENANT: opsera
  ENV: dev
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np

jobs:
  fix-ingress:
    name: "Fix Ingress - diagnose + patch"
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubeconfig (HUB + SPOKE)
        run: |
          aws eks update-kubeconfig --name ${HUB_CLUSTER} --region ${AWS_REGION} --alias hub
          aws eks update-kubeconfig --name ${SPOKE_CLUSTER} --region ${AWS_REGION} --alias spoke

      - name: Get Kubernetes events for ingress
        run: |
          NS="${TENANT}-${APP_NAME}-${ENV}"
          echo "=== Events in namespace ${NS} ==="
          kubectl --context spoke get events -n ${NS} --sort-by='.lastTimestamp' 2>/dev/null | tail -20
          echo ""
          echo "=== Describe ingress ==="
          kubectl --context spoke describe ingress ${APP_NAME} -n ${NS} 2>/dev/null || echo "Ingress not found"

      - name: Check service endpoints
        run: |
          NS="${TENANT}-${APP_NAME}-${ENV}"
          echo "=== Service ==="
          kubectl --context spoke get svc ${APP_NAME} -n ${NS} -o wide 2>/dev/null
          echo ""
          echo "=== Endpoints ==="
          kubectl --context spoke get endpoints ${APP_NAME} -n ${NS} 2>/dev/null
          echo ""
          echo "=== Pods ==="
          kubectl --context spoke get pods -n ${NS} -o wide 2>/dev/null

      - name: Patch ingress - add annotation kubernetes.io/ingress.class
        run: |
          NS="${TENANT}-${APP_NAME}-${ENV}"
          echo "Adding kubernetes.io/ingress.class annotation to force old controller pickup..."
          kubectl --context spoke annotate ingress ${APP_NAME} -n ${NS} \
            "kubernetes.io/ingress.class=nginx" \
            --overwrite 2>/dev/null || echo "Annotation patch failed"
          echo "✅ Annotation added"
          sleep 15
          echo "=== Ingress state after annotation ==="
          kubectl --context spoke get ingress ${APP_NAME} -n ${NS} -o wide 2>/dev/null

      - name: Wait and verify ingress address
        run: |
          NS="${TENANT}-${APP_NAME}-${ENV}"
          echo "Waiting for ingress address (2 minutes)..."
          for i in $(seq 1 12); do
            ADDRESS=$(kubectl --context spoke get ingress ${APP_NAME} -n ${NS} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            HOSTNAME=$(kubectl --context spoke get ingress ${APP_NAME} -n ${NS} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
            echo "[$i/12] IP: ${ADDRESS:-empty} | Hostname: ${HOSTNAME:-empty}"
            if [ -n "$ADDRESS" ] || [ -n "$HOSTNAME" ]; then
              echo "✅ Ingress address assigned: ${ADDRESS}${HOSTNAME}"
              break
            fi
            sleep 10
          done

      - name: Check nginx controller pod logs (last 100 lines)
        run: |
          echo "=== ingress-nginx-controller logs (errors) ==="
          kubectl --context spoke logs -n ingress-nginx \
            -l app.kubernetes.io/name=ingress-nginx \
            --tail=100 2>/dev/null | grep -iE "error|warn|test-0219|Sync" | tail -30 || true
          echo ""
          echo "=== All ingress-nginx pods ==="
          kubectl --context spoke get pods -n ingress-nginx -o wide 2>/dev/null || true
