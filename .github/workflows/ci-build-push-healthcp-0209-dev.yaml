# CI: Build, scan (warn), push, deploy to dev. RULE 175: immutable tags. RULE 147: AWS_ACCOUNT_ID per job.
name: CI Build & Deploy - healthcp-0209 (dev)
on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs: {}
permissions:
  contents: write
  id-token: write
env:
  APP_NAME: healthcp-0209
  TENANT: opsera
  AWS_REGION: us-west-2
  REGION_SHORT: usw2
  SPOKE_CLUSTER: opsera-usw2-np
jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
  build-push:
    needs: [security-scan]
    if: always() && (needs.security-scan.result == 'success' || needs.security-scan.result == 'skipped')
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      ecr_uri: ${{ steps.ecr.outputs.uri }}
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Get AWS Account ID
        id: account
        run: echo "id=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT
      - name: Set ECR URI
        id: ecr
        run: echo "uri=${{ steps.account.outputs.id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.APP_NAME }}" >> $GITHUB_OUTPUT
      - name: Set image tag (RULE 175)
        id: meta
        run: echo "tags=dev-${GITHUB_SHA::8}-$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT
      - name: Build
        run: docker build -f .opsera-${{ env.APP_NAME }}/Dockerfile -t ${{ steps.ecr.outputs.uri }}:${{ steps.meta.outputs.tags }} .
      - name: Grype scan (warn)
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --exit-code 0 --severity CRITICAL,HIGH ${{ steps.ecr.outputs.uri }}:${{ steps.meta.outputs.tags }} || true
      - name: Login to ECR
        run: aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.account.outputs.id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
      - name: Push
        run: docker push ${{ steps.ecr.outputs.uri }}:${{ steps.meta.outputs.tags }}
  update-manifests:
    needs: [build-push]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Update Kustomize image (RULE 131: replace PLACEHOLDER_ECR_URI)
        run: |
          ECR_URI="${{ needs.build-push.outputs.ecr_uri }}"
          TAG="${{ needs.build-push.outputs.image_tag }}"
          cd .opsera-${{ env.APP_NAME }}/k8s/overlays/dev
          sed -i.bak "s|PLACEHOLDER_ECR_URI|${ECR_URI}|g" kustomization.yaml deployment.yaml 2>/dev/null || true
          sed -i.bak "s|image: .*|image: ${ECR_URI}:${TAG}|g" deployment.yaml
          sed -i.bak "s|newTag:.*|newTag: ${TAG}|g" kustomization.yaml 2>/dev/null || true
      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git pull --rebase origin main
          git add .opsera-${{ env.APP_NAME }}/k8s/overlays/dev/
          git diff --staged --quiet || (git commit -m "ci(dev): deploy ${{ needs.build-push.outputs.image_tag }}" && git push origin main)
  deploy-dev:
    needs: [update-manifests]
    runs-on: ubuntu-latest
    env:
      KUBECONFIG: /tmp/kubeconfig
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Configure kubectl
        run: echo "${{ secrets.KUBECONFIG_SPOKE }}" | base64 -d > $KUBECONFIG
      - name: Refresh ECR secret (RULE 163)
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_TOKEN=$(aws ecr get-login-password --region ${{ env.AWS_REGION }})
          NS=opsera-${{ env.APP_NAME }}-dev
          kubectl create secret docker-registry ecr-pull-secret \
            --docker-server=$AWS_ACCOUNT_ID.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com \
            --docker-username=AWS --docker-password="$ECR_TOKEN" \
            --namespace=$NS --dry-run=client -o yaml | kubectl apply -f -
      - name: Apply and wait
        run: |
          kubectl apply -k .opsera-${{ env.APP_NAME }}/k8s/overlays/dev -n opsera-${{ env.APP_NAME }}-dev
          kubectl rollout status deployment/healthcp-0209 -n opsera-${{ env.APP_NAME }}-dev --timeout=5m
      - name: Slack (always)
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {"text": "healthcp-0209 dev deploy: ${{ job.status }}"}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
