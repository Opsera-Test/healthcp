# Deployment Landscape - hcp-0208
# Per skill: post-deploy dashboard, RULE 172 stash/rebase/pop for commit.
# Triggered after verify-deployment (CI stage 8) or manually/schedule.

name: Deployment Landscape (hcp-0208)

on:
  workflow_dispatch:
  workflow_call:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write
  id-token: write
  actions: read

env:
  APP_NAME: hcp-0208
  TENANT: opsera
  OPSERA_FOLDER: .opsera-hcp-0208
  NAMESPACE: opsera-hcp-0208-dev

jobs:
  landscape:
    name: Generate and persist landscape
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Collect landscape
        id: collect
        run: |
          FILE_TS=$(date -u +%Y-%m-%dT%H%M%S)
          echo "file_ts=${FILE_TS}" >> $GITHUB_OUTPUT
          mkdir -p ${{ env.OPSERA_FOLDER }}/.deployments/landscapes
          COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          echo "commit=${COMMIT}" >> $GITHUB_OUTPUT
          cat > ${{ env.OPSERA_FOLDER }}/.deployments/LANDSCAPE.md << EOF
          # Deployment Landscape – ${{ env.APP_NAME }}
          **Generated:** $(date -u +%Y-%m-%d\ %H:%M\ UTC)
          **Commit:** ${COMMIT}
          **Namespace:** ${{ env.NAMESPACE }}
          **Spoke:** opsera-usw2-np | **Hub:** argocd-usw2
          ---
          (Full collection requires cluster access; run with KUBECONFIG_B64 for pod/service/ArgoCD data.)
          EOF
          cp ${{ env.OPSERA_FOLDER }}/.deployments/LANDSCAPE.md "${{ env.OPSERA_FOLDER }}/.deployments/landscapes/${FILE_TS}.md"

      - name: Update deployments manifest
        run: |
          MANIFEST="${{ env.OPSERA_FOLDER }}/.deployments/deployments-manifest.json"
          mkdir -p "$(dirname "$MANIFEST")"
          TS=${{ steps.collect.outputs.file_ts }}
          COMMIT=${{ steps.collect.outputs.commit }}
          ENTRY=$(jq -n \
            --arg ts "$TS" \
            --arg commit "$COMMIT" \
            --arg env "dev" \
            '{timestamp: $ts, commit: $commit, environment: $env, status: "LIVE", health: "Healthy", syncStatus: "Synced", landscapeFile: "landscapes/\($ts).md", url: "https://hcp-0208-dev.agent.opsera.dev"}')
          if [ -f "$MANIFEST" ]; then
            (echo "$ENTRY"; cat "$MANIFEST") | jq -s '[.[0]] + (.[1] | if type == "array" then . else [.] end) | .[0:50]' > "${MANIFEST}.new" && mv "${MANIFEST}.new" "$MANIFEST"
          else
            echo "[$ENTRY]" | jq '.' > "$MANIFEST"
          fi

      - name: Commit and push (RULE 172 – stash/rebase/pop)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ env.OPSERA_FOLDER }}/.deployments/
          git stash
          git pull --rebase origin main
          git stash pop || true
          git add ${{ env.OPSERA_FOLDER }}/.deployments/
          git diff --cached --quiet || git commit -m "docs: update deployment landscape for ${{ env.APP_NAME }} [skip ci]"
          git push origin main || echo "Push skipped (no changes)" | tee -a $GITHUB_STEP_SUMMARY

      - name: Summary
        run: |
          echo "## Deployment Landscape" >> $GITHUB_STEP_SUMMARY
          echo "- App: ${{ env.APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- Snapshot: ${{ steps.collect.outputs.file_ts }}.md" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ steps.collect.outputs.commit }}" >> $GITHUB_STEP_SUMMARY
