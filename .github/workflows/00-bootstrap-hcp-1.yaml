# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BOOTSTRAP INFRASTRUCTURE - hcp-1
# Generated by Code-to-Cloud Enterprise v1.6
# RULE 61: Auto-registers spoke cluster with ArgoCD hub
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "00: Bootstrap Infrastructure (hcp-1)"

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Bootstrap action'
        required: true
        type: choice
        options:
          - full-bootstrap
          - ecr-only
          - argocd-only
          - verify
        default: full-bootstrap

env:
  APP_NAME: hcp-1
  AWS_REGION: us-east-1
  # RULE 70-71: Cluster naming convention
  HUB_CLUSTER: argocd-use1
  SPOKE_CLUSTER: opsera-use1-np
  NAMESPACE: hcp-1-dev
  ECR_REPOSITORY: hcp-1-frontend

permissions:
  contents: write
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: CREATE ECR REPOSITORY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-ecr:
    name: "ðŸ“¦ Create ECR Repository"
    runs-on: ubuntu-latest
    if: inputs.action == 'full-bootstrap' || inputs.action == 'ecr-only'
    outputs:
      ecr_uri: ${{ steps.ecr.outputs.ecr_uri }}
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # RULE 68: Use Access Keys (NOT OIDC)
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create ECR Repository
        id: ecr
        run: |
          echo "### ðŸ“¦ ECR Repository Setup" >> $GITHUB_STEP_SUMMARY
          
          # RULE 75: Auto-create ECR if not exists
          if aws ecr describe-repositories --repository-names $ECR_REPOSITORY 2>/dev/null; then
            echo "âœ… ECR repository already exists" >> $GITHUB_STEP_SUMMARY
          else
            aws ecr create-repository \
              --repository-name $ECR_REPOSITORY \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=AES256
            echo "âœ… Created ECR repository: $ECR_REPOSITORY" >> $GITHUB_STEP_SUMMARY
          fi
          
          ECR_URI="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}"
          echo "ecr_uri=${ECR_URI}" >> $GITHUB_OUTPUT
          echo "**ECR URI:** \`${ECR_URI}\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: SETUP ARGOCD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  setup-argocd:
    name: "ðŸ”„ Setup ArgoCD"
    runs-on: ubuntu-latest
    needs: [create-ecr]
    if: always() && (inputs.action == 'full-bootstrap' || inputs.action == 'argocd-only')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubectl for Hub Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          echo "### ðŸ”„ ArgoCD Setup" >> $GITHUB_STEP_SUMMARY

      # RULE 63: Create ArgoCD repository secret with GH_PAT
      - name: Create ArgoCD Repository Secret
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          echo "Creating ArgoCD repository secret..."
          
          kubectl create secret generic repo-${{ env.APP_NAME }} -n argocd \
            --from-literal=type=git \
            --from-literal=url="https://github.com/${{ github.repository }}" \
            --from-literal=username=git \
            --from-literal=password="${GH_PAT}" \
            --dry-run=client -o yaml | kubectl apply -f -
          
          kubectl label secret repo-${{ env.APP_NAME }} -n argocd \
            argocd.argoproj.io/secret-type=repository --overwrite
          
          echo "âœ… ArgoCD repository secret created" >> $GITHUB_STEP_SUMMARY

      # RULE 61: Auto-register spoke cluster with ArgoCD
      - name: Register Spoke Cluster with ArgoCD
        run: |
          echo "Registering spoke cluster with ArgoCD..."
          
          # Check if cluster already registered
          if kubectl get secret -n argocd -l argocd.argoproj.io/secret-type=cluster | grep -q "${{ env.SPOKE_CLUSTER }}"; then
            echo "âœ… Spoke cluster already registered" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Spoke cluster may need manual registration" >> $GITHUB_STEP_SUMMARY
            echo "Run: argocd cluster add ${{ env.SPOKE_CLUSTER }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create Namespace on Spoke Cluster
        run: |
          # Switch to spoke cluster
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          # RULE 69: Create namespace explicitly
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… Namespace ${{ env.NAMESPACE }} ready" >> $GITHUB_STEP_SUMMARY

      - name: Create ECR Pull Secret
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          # Get ECR login token
          ECR_TOKEN=$(aws ecr get-login-password --region ${{ env.AWS_REGION }})
          ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          
          # Create image pull secret
          kubectl create secret docker-registry ecr-registry-secret \
            --namespace=${{ env.NAMESPACE }} \
            --docker-server=${ECR_REGISTRY} \
            --docker-username=AWS \
            --docker-password="${ECR_TOKEN}" \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "âœ… ECR pull secret created" >> $GITHUB_STEP_SUMMARY

      - name: Apply ArgoCD Application
        run: |
          # Switch back to hub cluster
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          # Apply ArgoCD application
          kubectl apply -f .opsera-${{ env.APP_NAME }}/argocd/application-dev.yaml
          
          echo "âœ… ArgoCD application created" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: UPDATE MANIFESTS WITH ECR URI
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-manifests:
    name: "ðŸ“ Update Manifests"
    runs-on: ubuntu-latest
    needs: [create-ecr, setup-argocd]
    if: always() && inputs.action == 'full-bootstrap'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Update Kustomization with ECR URI
        env:
          ECR_URI: ${{ needs.create-ecr.outputs.ecr_uri }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          # Update kustomization.yaml with actual ECR URI
          ACTUAL_ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}"
          
          sed -i "s|PLACEHOLDER_ECR_URI|${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com|g" \
            .opsera-${{ env.APP_NAME }}/k8s/overlays/dev/kustomization.yaml
          
          echo "### ðŸ“ Manifest Updates" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Updated kustomization.yaml with ECR URI" >> $GITHUB_STEP_SUMMARY

      - name: Commit Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          git diff --cached --quiet || git commit -m "chore: Update manifests with ECR URI [skip ci]"
          git push

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # VERIFICATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify:
    name: "âœ… Verify Bootstrap"
    runs-on: ubuntu-latest
    needs: [create-ecr, setup-argocd, update-manifests]
    if: always()
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verification Summary
        run: |
          echo "### ðŸŽ¯ Bootstrap Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ECR Repository | ${{ needs.create-ecr.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ArgoCD Setup | ${{ needs.setup-argocd.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Manifest Update | ${{ needs.update-manifests.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Push code changes to trigger CI/CD pipeline" >> $GITHUB_STEP_SUMMARY
          echo "2. Run \`01-ci-build-push-hcp-1.yaml\` workflow" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor ArgoCD for deployment status" >> $GITHUB_STEP_SUMMARY
