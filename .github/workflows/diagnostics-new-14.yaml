# ════════════════════════════════════════════════════════════════════════════
# DIAGNOSTICS WORKFLOW - new-14
# Generated by Opsera Code-to-Cloud Enterprise v0.914
#
# RULE 93: Uses kubectl with EKS authentication (NOT ArgoCD CLI)
# ════════════════════════════════════════════════════════════════════════════
name: "Diagnostics new-14"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to diagnose'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev

env:
  APP_NAME: new-14
  TENANT: opsera
  AWS_REGION: us-west-2
  ECR_REPOSITORY: opsera/new-14
  HUB_CLUSTER_NAME: argocd-usw2
  SPOKE_CLUSTER_NAME: opsera-usw2-np

jobs:
  diagnose:
    name: "Run Diagnostics"
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: "1. Check ECR Repository"
        run: |
          echo "════════════════════════════════════════════════════════════════"
          echo "ECR REPOSITORY CHECK"
          echo "════════════════════════════════════════════════════════════════"
          aws ecr describe-repositories --repository-names "${{ env.ECR_REPOSITORY }}" || echo "ECR repository not found!"
          
          echo ""
          echo "Recent images:"
          aws ecr describe-images --repository-name "${{ env.ECR_REPOSITORY }}" \
            --query 'sort_by(imageDetails,& imagePushedAt)[-5:].{Tag:imageTags[0],Pushed:imagePushedAt,Size:imageSizeInBytes}' \
            --output table || echo "No images found"

      - name: "2. Check Hub Cluster (ArgoCD)"
        run: |
          echo "════════════════════════════════════════════════════════════════"
          echo "HUB CLUSTER CHECK - ${{ env.HUB_CLUSTER_NAME }}"
          echo "════════════════════════════════════════════════════════════════"
          
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
          
          echo ""
          echo "ArgoCD Application Status:"
          kubectl get application ${{ env.APP_NAME }}-${{ inputs.environment }} -n argocd -o wide || echo "Application not found"
          
          echo ""
          echo "Application Details:"
          kubectl get application ${{ env.APP_NAME }}-${{ inputs.environment }} -n argocd -o jsonpath='{.status}' | jq . || true
          
          echo ""
          echo "Repository Secret:"
          kubectl get secret repo-${{ env.APP_NAME }} -n argocd 2>/dev/null && echo "Exists" || echo "Not found"

      - name: "3. Check Spoke Cluster (Workloads)"
        run: |
          echo "════════════════════════════════════════════════════════════════"
          echo "SPOKE CLUSTER CHECK - ${{ env.SPOKE_CLUSTER_NAME }}"
          echo "════════════════════════════════════════════════════════════════"
          
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
          NAMESPACE="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ inputs.environment }}"
          
          echo ""
          echo "Namespace: ${NAMESPACE}"
          kubectl get namespace ${NAMESPACE} || echo "Namespace not found!"
          
          echo ""
          echo "Pods:"
          kubectl get pods -n ${NAMESPACE} -o wide || echo "No pods"
          
          echo ""
          echo "Deployments:"
          kubectl get deployments -n ${NAMESPACE} -o wide || echo "No deployments"
          
          echo ""
          echo "Services:"
          kubectl get services -n ${NAMESPACE} -o wide || echo "No services"
          
          echo ""
          echo "Ingress:"
          kubectl get ingress -n ${NAMESPACE} -o wide || echo "No ingress"
          
          echo ""
          echo "Endpoints:"
          kubectl get endpoints -n ${NAMESPACE} || echo "No endpoints"
          
          echo ""
          echo "ECR Credentials Secret:"
          kubectl get secret ecr-credentials -n ${NAMESPACE} 2>/dev/null && echo "Exists" || echo "Not found - run bootstrap!"

      - name: "4. Check Pod Details"
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
          NAMESPACE="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ inputs.environment }}"
          
          echo "════════════════════════════════════════════════════════════════"
          echo "POD DETAILS"
          echo "════════════════════════════════════════════════════════════════"
          
          POD=$(kubectl get pods -n ${NAMESPACE} -l app=${{ env.APP_NAME }} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
          
          if [ -n "$POD" ]; then
            echo "Pod: $POD"
            echo ""
            echo "Describe:"
            kubectl describe pod $POD -n ${NAMESPACE}
            
            echo ""
            echo "Logs (last 50 lines):"
            kubectl logs $POD -n ${NAMESPACE} --tail=50 || echo "No logs available"
          else
            echo "No pods found with label app=${{ env.APP_NAME }}"
          fi

      - name: "5. Check Recent Events"
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
          NAMESPACE="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ inputs.environment }}"
          
          echo "════════════════════════════════════════════════════════════════"
          echo "RECENT EVENTS"
          echo "════════════════════════════════════════════════════════════════"
          
          kubectl get events -n ${NAMESPACE} --sort-by='.lastTimestamp' | tail -20 || echo "No events"

      - name: "6. Health Check"
        run: |
          echo "════════════════════════════════════════════════════════════════"
          echo "HEALTH CHECK"
          echo "════════════════════════════════════════════════════════════════"
          
          HEALTH_URL="https://${{ env.TENANT }}-${{ env.APP_NAME }}-${{ inputs.environment }}.agent.opsera.dev/health"
          echo "URL: ${HEALTH_URL}"
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${HEALTH_URL} || echo "000")
          echo "HTTP Status: ${HTTP_CODE}"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Application is healthy!"
          elif [ "$HTTP_CODE" = "503" ]; then
            echo "❌ 503 Service Unavailable - No healthy backend pods"
            echo "   → Check pods, ECR credentials, and image pull status"
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "❌ 404 Not Found - Ingress not routing correctly"
            echo "   → Check ArgoCD destination cluster (RULE 149)"
          else
            echo "⚠️ Unexpected status - investigate further"
          fi

      - name: "7. Summary"
        run: |
          echo ""
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║              DIAGNOSTICS COMPLETE - new-14                       ║"
          echo "╠══════════════════════════════════════════════════════════════════╣"
          echo "║  Environment: ${{ inputs.environment }}"
          echo "║  Namespace:   ${{ env.TENANT }}-${{ env.APP_NAME }}-${{ inputs.environment }}"
          echo "║  URL:         https://${{ env.TENANT }}-${{ env.APP_NAME }}-${{ inputs.environment }}.agent.opsera.dev"
          echo "╚══════════════════════════════════════════════════════════════════╝"
