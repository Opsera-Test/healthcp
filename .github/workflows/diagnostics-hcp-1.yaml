# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DIAGNOSTICS WORKFLOW - hcp-1
# Generated by Code-to-Cloud Enterprise v1.6
# RULE 50: MANDATORY - For troubleshooting deployments
# version: v1.1
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ”¬ Diagnostics (hcp-1)"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options: [dev, qa, staging]
        default: dev
      diagnostic_type:
        description: 'Type of diagnostic'
        required: true
        type: choice
        options:
          - full-pipeline
          - pod-logs
          - argocd-debug
          - force-sync
          - ecr-check
        default: full-pipeline

env:
  APP_NAME: hcp-1
  AWS_REGION: us-east-1
  HUB_CLUSTER: argocd-use1
  SPOKE_CLUSTER: opsera-use1-np
  ECR_REPOSITORY: hcp-1-frontend

permissions:
  contents: read
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # FULL PIPELINE DIAGNOSTICS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  full-pipeline:
    name: "ðŸ” Full Pipeline Diagnostics"
    runs-on: ubuntu-latest
    if: inputs.diagnostic_type == 'full-pipeline'
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Stage 1 - ECR Check
        run: |
          echo "### ðŸ“¦ Stage 1: ECR Repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if aws ecr describe-repositories --repository-names ${{ env.ECR_REPOSITORY }} 2>/dev/null; then
            echo "âœ… ECR repository exists" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Latest Images:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            aws ecr describe-images --repository-name ${{ env.ECR_REPOSITORY }} \
              --query 'sort_by(imageDetails,&imagePushedAt)[-5:].{Tag:imageTags[0],Pushed:imagePushedAt}' \
              --output table 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No images found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ECR repository NOT found" >> $GITHUB_STEP_SUMMARY
            echo "Run bootstrap workflow to create ECR repository" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Stage 2 - Spoke Cluster Check
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Stage 2: EKS Spoke Cluster" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }} 2>/dev/null
          
          NAMESPACE="${{ env.APP_NAME }}-${{ inputs.environment }}"
          
          if kubectl get namespace ${NAMESPACE} 2>/dev/null; then
            echo "âœ… Namespace \`${NAMESPACE}\` exists" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Pods:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl get pods -n ${NAMESPACE} -o wide 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No pods found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Services:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl get svc -n ${NAMESPACE} 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No services found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Ingress:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl get ingress -n ${NAMESPACE} 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No ingress found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Namespace \`${NAMESPACE}\` NOT found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Stage 3 - ArgoCD Status
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Stage 3: ArgoCD Application" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }} 2>/dev/null
          
          ARGO_APP="${{ env.APP_NAME }}-${{ inputs.environment }}"
          
          if kubectl get application ${ARGO_APP} -n argocd 2>/dev/null; then
            SYNC_STATUS=$(kubectl get application ${ARGO_APP} -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
            HEALTH_STATUS=$(kubectl get application ${ARGO_APP} -n argocd -o jsonpath='{.status.health.status}' 2>/dev/null || echo "Unknown")
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Sync Status | \`${SYNC_STATUS}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Health Status | \`${HEALTH_STATUS}\` |" >> $GITHUB_STEP_SUMMARY
            
            if [ "$SYNC_STATUS" != "Synced" ] || [ "$HEALTH_STATUS" != "Healthy" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Application Details:**" >> $GITHUB_STEP_SUMMARY
              echo '```yaml' >> $GITHUB_STEP_SUMMARY
              kubectl get application ${ARGO_APP} -n argocd -o yaml 2>/dev/null | head -100 >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ ArgoCD application \`${ARGO_APP}\` NOT found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Stage 4 - Recent Events
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Stage 4: Recent Events" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }} 2>/dev/null
          
          NAMESPACE="${{ env.APP_NAME }}-${{ inputs.environment }}"
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get events -n ${NAMESPACE} --sort-by='.lastTimestamp' 2>/dev/null | tail -20 >> $GITHUB_STEP_SUMMARY || echo "No events found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # POD LOGS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  pod-logs:
    name: "ðŸ“‹ Pod Logs"
    runs-on: ubuntu-latest
    if: inputs.diagnostic_type == 'pod-logs'
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Pod Logs
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          NAMESPACE="${{ env.APP_NAME }}-${{ inputs.environment }}"
          
          echo "### ðŸ“‹ Pod Logs" >> $GITHUB_STEP_SUMMARY
          
          for POD in $(kubectl get pods -n ${NAMESPACE} -l app=${{ env.APP_NAME }} -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Pod: \`${POD}\`" >> $GITHUB_STEP_SUMMARY
            
            # Current logs
            echo "**Current Logs:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl logs ${POD} -n ${NAMESPACE} --tail=50 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No logs available" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Previous container logs (if crashed)
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Previous Container (if crashed):**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl logs ${POD} -n ${NAMESPACE} --previous --tail=20 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No previous logs" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          done
          
          if [ -z "$(kubectl get pods -n ${NAMESPACE} -l app=${{ env.APP_NAME }} -o jsonpath='{.items[*].metadata.name}' 2>/dev/null)" ]; then
            echo "âš ï¸ No pods found in namespace \`${NAMESPACE}\`" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # FORCE SYNC
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  force-sync:
    name: "âš¡ Force Sync"
    runs-on: ubuntu-latest
    if: inputs.diagnostic_type == 'force-sync'
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Force Sync ArgoCD
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          ARGO_APP="${{ env.APP_NAME }}-${{ inputs.environment }}"
          
          echo "### âš¡ Force Sync: \`${ARGO_APP}\`" >> $GITHUB_STEP_SUMMARY
          
          # Hard refresh (clear cache)
          kubectl annotate application ${ARGO_APP} -n argocd argocd.argoproj.io/refresh=hard --overwrite
          
          echo "âœ… Force sync triggered" >> $GITHUB_STEP_SUMMARY
          
          # Wait and check status
          sleep 30
          
          SYNC_STATUS=$(kubectl get application ${ARGO_APP} -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
          HEALTH_STATUS=$(kubectl get application ${ARGO_APP} -n argocd -o jsonpath='{.status.health.status}' 2>/dev/null || echo "Unknown")
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status after sync:**" >> $GITHUB_STEP_SUMMARY
          echo "- Sync: \`${SYNC_STATUS}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Health: \`${HEALTH_STATUS}\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ECR CHECK
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ecr-check:
    name: "ðŸ“¦ ECR Check"
    runs-on: ubuntu-latest
    if: inputs.diagnostic_type == 'ecr-check'
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: List ECR Images
        run: |
          echo "### ðŸ“¦ ECR Images: \`${{ env.ECR_REPOSITORY }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws ecr describe-images --repository-name ${{ env.ECR_REPOSITORY }} \
            --query 'sort_by(imageDetails,&imagePushedAt)[-10:].{Tag:imageTags[0],Size:imageSizeInBytes,Pushed:imagePushedAt}' \
            --output table 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "Failed to list images" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
