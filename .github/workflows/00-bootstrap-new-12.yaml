# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Bootstrap Workflow - new-12
# One-time setup: ECR, ArgoCD spoke registration, secrets, and application
# Generated by Opsera Code-to-Cloud Enterprise v0.912
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: "00-Bootstrap new-12"

on:
  workflow_dispatch:
    inputs:
      force_recreate:
        description: 'Force recreate all resources'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  APP_NAME: new-12
  TENANT: opsera
  AWS_REGION: us-west-2
  ECR_REPOSITORY: opsera/new-12
  HUB_CLUSTER: argocd-usw2
  HUB_CLUSTER_NAME: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np
  ARGOCD_SERVER: argocd-usw2.agent.opsera.dev

concurrency:
  group: bootstrap-new-12
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 1: Verify Prerequisites
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-prerequisites:
    name: "Verify Prerequisites"
    runs-on: ubuntu-latest
    outputs:
      ecr_exists: ${{ steps.check-ecr.outputs.exists }}
      ecr_uri: ${{ steps.check-ecr.outputs.ecr_uri }}
      repo_url: ${{ steps.repo-info.outputs.repo_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get repository info
        id: repo-info
        run: |
          REPO_URL="https://github.com/${{ github.repository }}.git"
          echo "repo_url=${REPO_URL}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Repository: ${REPO_URL}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS connectivity
        run: |
          echo "ğŸ” Verifying AWS credentials..."
          aws sts get-caller-identity
          echo "âœ… AWS credentials valid"

      - name: Check if ECR repository exists
        id: check-ecr
        run: |
          ECR_URI="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}"
          echo "ecr_uri=${ECR_URI}" >> $GITHUB_OUTPUT
          
          if aws ecr describe-repositories --repository-names "${{ env.ECR_REPOSITORY }}" 2>/dev/null; then
            echo "âœ… ECR repository exists: ${{ env.ECR_REPOSITORY }}"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¦ ECR repository does not exist, will create"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 2: Create ECR Repository
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-ecr:
    name: "Create ECR Repository"
    runs-on: ubuntu-latest
    needs: verify-prerequisites
    if: needs.verify-prerequisites.outputs.ecr_exists == 'false' || github.event.inputs.force_recreate == 'true'
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create ECR repository
        run: |
          echo "ğŸ“¦ Creating ECR repository: ${{ env.ECR_REPOSITORY }}"
          aws ecr create-repository \
            --repository-name "${{ env.ECR_REPOSITORY }}" \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256 \
            --tags Key=Application,Value=${{ env.APP_NAME }} Key=Tenant,Value=${{ env.TENANT }} Key=ManagedBy,Value=opsera
          echo "âœ… ECR repository created successfully"

      - name: Set lifecycle policy
        run: |
          echo "ğŸ”„ Setting ECR lifecycle policy..."
          aws ecr put-lifecycle-policy \
            --repository-name "${{ env.ECR_REPOSITORY }}" \
            --lifecycle-policy-text '{
              "rules": [
                {
                  "rulePriority": 1,
                  "description": "Keep last 10 images",
                  "selection": {
                    "tagStatus": "any",
                    "countType": "imageCountMoreThan",
                    "countNumber": 10
                  },
                  "action": {
                    "type": "expire"
                  }
                }
              ]
            }'
          echo "âœ… Lifecycle policy applied"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 3: Register Spoke Cluster (Optional - uses kubectl)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  register-spoke:
    name: "Register Spoke Cluster"
    runs-on: ubuntu-latest
    needs: [verify-prerequisites, create-ecr]
    if: always() && needs.verify-prerequisites.result == 'success' && (needs.create-ecr.result == 'success' || needs.create-ecr.result == 'skipped')
    continue-on-error: true
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubectl for Hub
        run: |
          echo "ğŸ”§ Configuring kubectl for hub cluster..."
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
          echo "âœ… kubectl configured"

      - name: Check spoke cluster registration
        run: |
          echo "ğŸ” Checking if spoke cluster is registered..."
          if kubectl get secret -n argocd -l argocd.argoproj.io/secret-type=cluster 2>/dev/null | grep -q "${{ env.SPOKE_CLUSTER }}"; then
            echo "âœ… Spoke cluster already registered: ${{ env.SPOKE_CLUSTER }}"
          else
            echo "ğŸ“¡ Spoke cluster not found in ArgoCD secrets"
            echo "âš ï¸  Manual spoke cluster registration may be required"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 4: Update Configuration Placeholders
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-config:
    name: "Update Configuration"
    runs-on: ubuntu-latest
    needs: [verify-prerequisites, create-ecr, register-spoke]
    if: always() && needs.verify-prerequisites.result == 'success' && (needs.create-ecr.result == 'success' || needs.create-ecr.result == 'skipped')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update placeholders in manifests
        run: |
          ECR_URI="${{ needs.verify-prerequisites.outputs.ecr_uri }}"
          REPO_URL="${{ needs.verify-prerequisites.outputs.repo_url }}"
          
          echo "ğŸ”§ Updating ECR URI placeholder to: ${ECR_URI}"
          echo "ğŸ”§ Updating Repo URL placeholder to: ${REPO_URL}"
          
          # Update Kustomization with ECR URI
          sed -i "s|PLACEHOLDER_ECR_URI|${ECR_URI}|g" .opsera-new-12/k8s/overlays/dev/kustomization.yaml
          sed -i "s|PLACEHOLDER_ECR_URI|${ECR_URI}|g" .opsera-new-12/k8s/base/deployment.yaml
          
          # Update ArgoCD application with repo URL
          sed -i "s|PLACEHOLDER_REPO_URL|${REPO_URL}|g" .opsera-new-12/argocd/dev/application.yaml
          
          echo "âœ… Placeholders updated"

      - name: Commit configuration updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          if git diff --staged --quiet; then
            echo "ğŸ“ No changes to commit"
          else
            git commit -m "chore(bootstrap): Update ECR URI and repo URL placeholders [skip ci]"
            git push
            echo "âœ… Configuration committed"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 5: Create Repository Secret (uses kubectl)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-repo-secret:
    name: "Create Repository Secret"
    runs-on: ubuntu-latest
    needs: [verify-prerequisites, create-ecr, register-spoke, update-config]
    if: always() && needs.update-config.result == 'success'
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubectl for Hub
        run: |
          echo "ğŸ”§ Configuring kubectl for hub cluster..."
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
          echo "âœ… kubectl configured"

      - name: Create repository secret
        run: |
          REPO_URL="${{ needs.verify-prerequisites.outputs.repo_url }}"
          SECRET_NAME="repo-${{ env.APP_NAME }}"
          
          echo "ğŸ” Creating repository secret for: ${REPO_URL}"
          
          # Check if secret already exists
          if kubectl get secret ${SECRET_NAME} -n argocd 2>/dev/null; then
            echo "âœ… Repository secret already exists"
          else
            kubectl create secret generic ${SECRET_NAME} \
              --namespace argocd \
              --from-literal=url="${REPO_URL}" \
              --from-literal=username="${{ secrets.GH_USERNAME }}" \
              --from-literal=password="${{ secrets.GH_PAT }}" \
              --from-literal=type="git"
            
            kubectl label secret ${SECRET_NAME} -n argocd \
              argocd.argoproj.io/secret-type=repository
            
            echo "âœ… Repository secret created"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 6: Apply ArgoCD Application (uses kubectl)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  apply-argocd-app:
    name: "Apply ArgoCD Application"
    runs-on: ubuntu-latest
    needs: [verify-prerequisites, create-ecr, register-spoke, update-config, create-repo-secret]
    if: always() && needs.update-config.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubectl for Hub
        run: |
          echo "ğŸ”§ Configuring kubectl for hub cluster..."
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
          echo "âœ… kubectl configured"

      - name: Apply ArgoCD Application
        run: |
          echo "ğŸš€ Applying ArgoCD Application: ${{ env.APP_NAME }}-dev"
          
          # Pull latest changes
          git pull origin main
          
          # Apply the ArgoCD Application manifest
          kubectl apply -f .opsera-new-12/argocd/dev/application.yaml
          
          echo "âœ… ArgoCD Application applied for dev"

      - name: Verify Application Created
        run: |
          echo "ğŸ” Verifying ArgoCD Application..."
          kubectl get application ${{ env.APP_NAME }}-dev -n argocd
          echo "âœ… Application verified"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 7: Summary
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: "Summary"
    runs-on: ubuntu-latest
    needs: [verify-prerequisites, create-ecr, register-spoke, update-config, create-repo-secret, apply-argocd-app]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                     BOOTSTRAP SUMMARY - new-12                               â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Prerequisites:     ${{ needs.verify-prerequisites.result }}"
          echo "â•‘  ECR Creation:      ${{ needs.create-ecr.result }}"
          echo "â•‘  Spoke Registration: ${{ needs.register-spoke.result }}"
          echo "â•‘  Config Update:     ${{ needs.update-config.result }}"
          echo "â•‘  Repo Secret:       ${{ needs.create-repo-secret.result }}"
          echo "â•‘  ArgoCD App:        ${{ needs.apply-argocd-app.result }}"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ECR URI: ${{ needs.verify-prerequisites.outputs.ecr_uri }}"
          echo "â•‘  Repo URL: ${{ needs.verify-prerequisites.outputs.repo_url }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [[ "${{ needs.apply-argocd-app.result }}" == "success" ]]; then
            echo ""
            echo "âœ… Bootstrap completed successfully!"
            echo "ğŸš€ Next step: Push code changes to trigger CI/CD pipeline"
            echo "ğŸŒ Application will be available at: https://opsera-new-12-dev.agent.opsera.dev"
          else
            echo ""
            echo "âš ï¸  Bootstrap completed with some issues. Check individual job logs."
          fi
