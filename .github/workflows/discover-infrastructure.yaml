# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HEALTHCP: Infrastructure Discovery
# Discovers existing AWS resources (EKS, ECR, Route53, VPC)
# RULE 57: All AWS commands run in GitHub Actions
# Generated by Opsera Code-to-Cloud Enterprise v1.4
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ” healthcp: Discover Infrastructure"

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: 'AWS Region to scan'
        required: true
        type: choice
        options:
          - us-east-1
          - us-west-2
          - eu-west-1
          - ap-south-1
        default: us-east-1

env:
  AWS_REGION: ${{ inputs.aws_region || 'us-east-1' }}

permissions:
  contents: read
  id-token: write

jobs:
  discover:
    name: "ðŸ” Discover AWS Infrastructure"
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
        continue-on-error: true
        id: aws-creds

      - name: Check AWS Access
        id: check-access
        run: |
          echo "### ðŸ”‘ AWS Access Check" >> $GITHUB_STEP_SUMMARY
          
          # Check if we have valid credentials
          IDENTITY=$(aws sts get-caller-identity 2>/dev/null || echo "")
          
          if [ -n "$IDENTITY" ]; then
            ACCOUNT=$(echo "$IDENTITY" | jq -r '.Account')
            ARN=$(echo "$IDENTITY" | jq -r '.Arn')
            echo "âœ… AWS Access Configured" >> $GITHUB_STEP_SUMMARY
            echo "- **Account:** \`$ACCOUNT\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Identity:** \`$ARN\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Region:** \`${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
            echo "has_access=true" >> $GITHUB_OUTPUT
            echo "account_id=$ACCOUNT" >> $GITHUB_OUTPUT
          else
            echo "âŒ **AWS credentials not configured**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Configure the following secrets at org or repo level:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo 'gh secret set AWS_ACCESS_KEY_ID --body "AKIA..."' >> $GITHUB_STEP_SUMMARY
            echo 'gh secret set AWS_SECRET_ACCESS_KEY --body "..."' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "has_access=false" >> $GITHUB_OUTPUT
          fi

      - name: Discover EKS Clusters
        if: steps.check-access.outputs.has_access == 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ EKS Clusters in ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          CLUSTERS=$(aws eks list-clusters --query 'clusters' --output json 2>/dev/null || echo "[]")
          CLUSTER_COUNT=$(echo "$CLUSTERS" | jq '. | length')
          
          if [ "$CLUSTER_COUNT" -eq 0 ]; then
            echo "No EKS clusters found in this region." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recommendation:** Use Terraform to create a new cluster:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo 'cd .opsera-healthcp/terraform && terraform init && terraform apply' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "| Cluster Name | Status | Version | Endpoint |" >> $GITHUB_STEP_SUMMARY
            echo "|--------------|--------|---------|----------|" >> $GITHUB_STEP_SUMMARY
            
            for CLUSTER in $(echo "$CLUSTERS" | jq -r '.[]'); do
              INFO=$(aws eks describe-cluster --name "$CLUSTER" --query 'cluster' --output json 2>/dev/null || echo "{}")
              STATUS=$(echo "$INFO" | jq -r '.status // "Unknown"')
              VERSION=$(echo "$INFO" | jq -r '.version // "N/A"')
              ENDPOINT=$(echo "$INFO" | jq -r '.endpoint // "N/A"' | sed 's/https:\/\///' | cut -c1-40)
              
              echo "| \`$CLUSTER\` | $STATUS | $VERSION | \`$ENDPOINT...\` |" >> $GITHUB_STEP_SUMMARY
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Found $CLUSTER_COUNT cluster(s)** - You can use an existing cluster for healthcp deployment." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Discover ECR Repositories
        if: steps.check-access.outputs.has_access == 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ECR Repositories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          REPOS=$(aws ecr describe-repositories --query 'repositories[*].repositoryName' --output json 2>/dev/null || echo "[]")
          REPO_COUNT=$(echo "$REPOS" | jq '. | length')
          
          if [ "$REPO_COUNT" -eq 0 ]; then
            echo "No ECR repositories found." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**The CI/CD pipeline will auto-create \`healthcp\` repository on first build.**" >> $GITHUB_STEP_SUMMARY
          else
            # Check if healthcp repo exists
            HEALTHCP_EXISTS=$(echo "$REPOS" | jq 'contains(["healthcp"])')
            
            echo "| Repository | healthcp Compatible |" >> $GITHUB_STEP_SUMMARY
            echo "|------------|---------------------|" >> $GITHUB_STEP_SUMMARY
            
            for REPO in $(echo "$REPOS" | jq -r '.[]' | head -10); do
              if [ "$REPO" = "healthcp" ]; then
                echo "| \`$REPO\` | âœ… **Ready to use** |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| \`$REPO\` | - |" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
            if [ "$HEALTHCP_EXISTS" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **\`healthcp\` ECR repository exists** - Ready for deployments!" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "â„¹ï¸ **\`healthcp\` repository will be auto-created on first build**" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Discover Route53 Hosted Zones
        if: steps.check-access.outputs.has_access == 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Route53 Hosted Zones" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          ZONES=$(aws route53 list-hosted-zones --query 'HostedZones' --output json 2>/dev/null || echo "[]")
          ZONE_COUNT=$(echo "$ZONES" | jq '. | length')
          
          if [ "$ZONE_COUNT" -eq 0 ]; then
            echo "No Route53 hosted zones found." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**DNS automation will use manual fallback mode.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Domain | Zone ID | Type |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|---------|------|" >> $GITHUB_STEP_SUMMARY
            
            echo "$ZONES" | jq -r '.[] | "\(.Name)\t\(.Id)\t\(.Config.PrivateZone)"' | while IFS=$'\t' read -r NAME ID PRIVATE; do
              ZONE_ID=$(echo "$ID" | sed 's|/hostedzone/||')
              TYPE=$([ "$PRIVATE" = "true" ] && echo "Private" || echo "Public")
              echo "| \`$NAME\` | \`$ZONE_ID\` | $TYPE |" >> $GITHUB_STEP_SUMMARY
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**To enable DNS automation, add the Zone ID as a variable:**" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo 'gh variable set ROUTE53_HOSTED_ZONE_ID --body "ZONE_ID_HERE"' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Discover VPCs
        if: steps.check-access.outputs.has_access == 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ VPCs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          VPCS=$(aws ec2 describe-vpcs --query 'Vpcs' --output json 2>/dev/null || echo "[]")
          VPC_COUNT=$(echo "$VPCS" | jq '. | length')
          
          echo "| VPC ID | CIDR | Name |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          echo "$VPCS" | jq -r '.[] | "\(.VpcId)\t\(.CidrBlock)\t\((.Tags // []) | map(select(.Key == "Name")) | .[0].Value // "unnamed")"' | while IFS=$'\t' read -r VPC_ID CIDR NAME; do
            echo "| \`$VPC_ID\` | \`$CIDR\` | $NAME |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Found $VPC_COUNT VPC(s)**" >> $GITHUB_STEP_SUMMARY

      - name: Summary & Recommendations
        if: steps.check-access.outputs.has_access == 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Based on discovery results:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Configure GitHub Secrets** (if not already done):" >> $GITHUB_STEP_SUMMARY
          echo '   ```bash' >> $GITHUB_STEP_SUMMARY
          echo "   gh secret set AWS_ROLE_ARN --body \"arn:aws:iam::${{ steps.check-access.outputs.account_id }}:role/healthcp-github-actions-role\"" >> $GITHUB_STEP_SUMMARY
          echo '   ```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Update Kustomize manifests** with your AWS account ID:" >> $GITHUB_STEP_SUMMARY
          echo '   ```bash' >> $GITHUB_STEP_SUMMARY
          echo "   sed -i 's/ACCOUNT_ID/${{ steps.check-access.outputs.account_id }}/g' .opsera-healthcp/k8s/overlays/*/kustomization.yaml" >> $GITHUB_STEP_SUMMARY
          echo '   ```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **Push changes and deploy:**" >> $GITHUB_STEP_SUMMARY
          echo '   ```bash' >> $GITHUB_STEP_SUMMARY
          echo "   git add . && git commit -m 'feat: Add CI/CD pipeline' && git push" >> $GITHUB_STEP_SUMMARY
          echo '   ```' >> $GITHUB_STEP_SUMMARY

      - name: No Access Summary
        if: steps.check-access.outputs.has_access != 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Setup Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To enable AWS infrastructure discovery:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Create IAM Role** with OIDC trust for GitHub Actions" >> $GITHUB_STEP_SUMMARY
          echo "2. **Add AWS_ROLE_ARN secret** to this repository" >> $GITHUB_STEP_SUMMARY
          echo "3. **Re-run this workflow**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Or use Terraform to provision new infrastructure:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'cd .opsera-healthcp/terraform' >> $GITHUB_STEP_SUMMARY
          echo 'terraform init' >> $GITHUB_STEP_SUMMARY
          echo 'terraform apply' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
