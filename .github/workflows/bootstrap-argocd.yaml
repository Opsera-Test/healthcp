# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HEALTHCP: Bootstrap ArgoCD on Hub Cluster
# Installs ArgoCD on hub (argocd-use1) and registers spoke (opsera-use1-np)
# Generated by Opsera Code-to-Cloud Enterprise v1.4
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ”§ Bootstrap ArgoCD"

on:
  workflow_dispatch:
    inputs:
      install_argocd:
        description: 'Install ArgoCD on hub cluster'
        type: boolean
        default: true
      register_spoke:
        description: 'Register spoke cluster with ArgoCD'
        type: boolean
        default: true

env:
  AWS_REGION: us-east-1
  # Naming Convention: argocd-{short-region} / {tenant}-{short-region}-{prod/np}
  HUB_CLUSTER: argocd-use1
  SPOKE_CLUSTER: opsera-use1-np
  ARGOCD_NAMESPACE: argocd
  APP_NAMESPACE: healthcp-dev

jobs:
  bootstrap:
    name: "ðŸ”§ Bootstrap ArgoCD"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.29.0'

      - name: Configure kubeconfig for Hub cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }} --alias hub
          echo "### ðŸŽ¯ Hub Cluster Connected" >> $GITHUB_STEP_SUMMARY
          kubectl config current-context
          kubectl get nodes

      - name: Install ArgoCD on Hub
        if: inputs.install_argocd
        run: |
          echo "### ðŸ“¦ Installing ArgoCD on ${{ env.HUB_CLUSTER }}" >> $GITHUB_STEP_SUMMARY
          
          # Create namespace
          kubectl create namespace ${{ env.ARGOCD_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          
          # Install ArgoCD
          kubectl apply -n ${{ env.ARGOCD_NAMESPACE }} -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
          
          # Wait for ArgoCD to be ready
          echo "Waiting for ArgoCD pods to be ready..."
          kubectl wait --for=condition=available deployment/argocd-server -n ${{ env.ARGOCD_NAMESPACE }} --timeout=300s || true
          
          # Get initial admin password
          sleep 30
          ARGOCD_PASSWORD=$(kubectl -n ${{ env.ARGOCD_NAMESPACE }} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" 2>/dev/null | base64 -d || echo "Password not yet available")
          
          echo "âœ… ArgoCD installed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Initial Admin Password:** \`$ARGOCD_PASSWORD\`" >> $GITHUB_STEP_SUMMARY

      - name: Configure kubeconfig for Spoke cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }} --alias spoke
          
          # Switch back to hub for ArgoCD operations
          kubectl config use-context hub

      - name: Register Spoke Cluster with ArgoCD
        if: inputs.register_spoke
        run: |
          echo "### ðŸ”— Registering Spoke Cluster" >> $GITHUB_STEP_SUMMARY
          
          # Get spoke cluster details
          SPOKE_SERVER=$(aws eks describe-cluster --name ${{ env.SPOKE_CLUSTER }} --query 'cluster.endpoint' --output text)
          SPOKE_CA=$(aws eks describe-cluster --name ${{ env.SPOKE_CLUSTER }} --query 'cluster.certificateAuthority.data' --output text)
          
          # Create ServiceAccount for ArgoCD in spoke cluster
          kubectl config use-context spoke
          
          kubectl create namespace ${{ env.APP_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          
          # Create ServiceAccount and ClusterRoleBinding for ArgoCD
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: argocd-manager
            namespace: kube-system
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: argocd-manager-role-binding
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: cluster-admin
          subjects:
          - kind: ServiceAccount
            name: argocd-manager
            namespace: kube-system
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: argocd-manager-token
            namespace: kube-system
            annotations:
              kubernetes.io/service-account.name: argocd-manager
          type: kubernetes.io/service-account-token
          EOF
          
          sleep 10
          
          # Get the token
          SPOKE_TOKEN=$(kubectl get secret argocd-manager-token -n kube-system -o jsonpath='{.data.token}' | base64 -d)
          
          # Switch back to hub
          kubectl config use-context hub
          
          # Register the spoke cluster in ArgoCD
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: ${{ env.SPOKE_CLUSTER }}-cluster
            namespace: ${{ env.ARGOCD_NAMESPACE }}
            labels:
              argocd.argoproj.io/secret-type: cluster
          type: Opaque
          stringData:
            name: "${{ env.SPOKE_CLUSTER }}"
            server: "$SPOKE_SERVER"
            config: |
              {
                "bearerToken": "$SPOKE_TOKEN",
                "tlsClientConfig": {
                  "insecure": false,
                  "caData": "$SPOKE_CA"
                }
              }
          EOF
          
          echo "âœ… Spoke cluster registered: \`${{ env.SPOKE_CLUSTER }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** \`$SPOKE_SERVER\`" >> $GITHUB_STEP_SUMMARY

      - name: Create App Namespace on Spoke
        run: |
          kubectl config use-context spoke
          kubectl create namespace ${{ env.APP_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… Namespace \`${{ env.APP_NAMESPACE }}\` ready on spoke cluster" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ‰ ArgoCD Bootstrap Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Hub Cluster | \`${{ env.HUB_CLUSTER }}\` âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Spoke Cluster | \`${{ env.SPOKE_CLUSTER }}\` âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| ArgoCD | Installed âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster Registration | Complete âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Step:** Run the CI/CD workflow to deploy healthcp" >> $GITHUB_STEP_SUMMARY
