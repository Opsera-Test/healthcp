# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HEALTHCP: Architecture Workflow
# RULE 51: MANDATORY - Generate during bootstrap
# version: v1.1
# Generated by Opsera Code-to-Cloud Enterprise v1.4
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ“ healthcp: Architecture"

on:
  push:
    branches: [main]
    paths:
      - '.opsera-healthcp/**'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-architecture:
    name: "ðŸ“ Generate Architecture Diagram"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Analyze Infrastructure
        id: analyze
        run: |
          echo "### ðŸ“ Architecture Analysis" >> $GITHUB_STEP_SUMMARY
          
          # Count environments
          ENV_COUNT=$(ls -d .opsera-healthcp/k8s/overlays/*/ 2>/dev/null | wc -l || echo "0")
          echo "environments=${ENV_COUNT}" >> $GITHUB_OUTPUT
          echo "Found ${ENV_COUNT} environments" >> $GITHUB_STEP_SUMMARY

      - name: Generate Mermaid Diagram
        run: |
          mkdir -p .opsera-healthcp/docs
          
          cat << 'MERMAID' > .opsera-healthcp/docs/architecture.md
          # healthcp Architecture
          
          > Generated by Opsera Code-to-Cloud Enterprise v1.4
          
          ## System Overview
          
          ```mermaid
          graph TB
              subgraph "GitHub"
                  GH[GitHub Repository]
                  GHA[GitHub Actions]
              end
          
              subgraph "Container Registry"
                  ECR[AWS ECR<br/>healthcp]
              end
          
              subgraph "GitOps"
                  ARGO[ArgoCD Hub]
              end
          
              subgraph "AWS EKS Cluster"
                  subgraph "DEV Environment"
                      DEV_NS[healthcp-dev]
                      DEV_DEPLOY[Rolling Deployment]
                  end
          
                  subgraph "QA Environment"
                      QA_NS[healthcp-qa]
                      QA_CANARY[Canary Rollout<br/>10%â†’30%â†’60%â†’100%]
                  end
          
                  subgraph "Staging Environment"
                      STG_NS[healthcp-staging]
                      STG_BG[Blue-Green<br/>Preview + Active]
                  end
              end
          
              subgraph "External"
                  R53[Route53 DNS]
                  USERS[Users]
              end
          
              GH -->|push| GHA
              GHA -->|build & push| ECR
              GHA -->|update manifests| GH
              GH -->|sync| ARGO
              ARGO -->|deploy| DEV_NS
              ARGO -->|deploy| QA_NS
              ARGO -->|deploy| STG_NS
          
              DEV_NS --> DEV_DEPLOY
              QA_NS --> QA_CANARY
              STG_NS --> STG_BG
          
              R53 --> DEV_NS
              R53 --> QA_NS
              R53 --> STG_NS
              USERS --> R53
          ```
          
          ## Deployment Pipeline
          
          ```mermaid
          sequenceDiagram
              participant Dev as Developer
              participant GH as GitHub
              participant GHA as GitHub Actions
              participant QG as Quality Gates
              participant ECR as AWS ECR
              participant ARGO as ArgoCD
              participant K8S as Kubernetes
          
              Dev->>GH: Push to main
              par Parallel Execution
                  GH->>GHA: Trigger CI/CD
                  GH->>QG: Trigger Quality Gates
              end
              
              QG->>QG: SAST (SonarQube)
              QG->>QG: SCA (Grype)
              QG->>QG: Secrets (Gitleaks)
              
              GHA->>ECR: Build & Push Image
              GHA->>GH: Update DEV manifests
              GH->>ARGO: Webhook notification
              ARGO->>K8S: Deploy to DEV (Rolling)
              K8S-->>GHA: DEV healthy
              
              Note over Dev,K8S: Manual Promotion Required
              
              Dev->>GHA: Trigger QA promotion
              GHA->>GH: Update QA manifests
              ARGO->>K8S: Deploy to QA (Canary)
              K8S-->>GHA: QA healthy
              
              Dev->>GHA: Trigger Staging promotion
              GHA->>GH: Update Staging manifests
              ARGO->>K8S: Deploy to Staging (Blue-Green)
          ```
          
          ## Environment Details
          
          | Environment | Strategy | Namespace | URL |
          |-------------|----------|-----------|-----|
          | DEV | Rolling Update | healthcp-dev | https://healthcp-dev.agents.opsera.dev |
          | QA | Canary (10%â†’30%â†’60%â†’100%) | healthcp-qa | https://healthcp-qa.agents.opsera.dev |
          | Staging | Blue-Green | healthcp-staging | https://healthcp-staging.agents.opsera.dev |
          
          ## Quality Gates
          
          | Gate | Tool | Description |
          |------|------|-------------|
          | ðŸ” Secrets | Gitleaks | Scans git history for leaked secrets |
          | ðŸ” SAST | SonarQube | Static code analysis |
          | ðŸ›¡ï¸ SCA | Grype | Dependency vulnerability scanning |
          
          ## Integrations
          
          | Integration | Purpose |
          |-------------|---------|
          | Slack | Deployment notifications |
          | Jira | Deployment tracking tickets |
          | New Relic | APM for canary analysis |
          | Route53 | DNS automation |
          
          ---
          *Generated: $(date -u +"%Y-%m-%d %H:%M UTC") | Code-to-Cloud Enterprise v1.4*
          MERMAID
          
          echo "### ðŸ“ Architecture Document Generated" >> $GITHUB_STEP_SUMMARY

      - name: Commit Architecture Doc
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .opsera-healthcp/docs/architecture.md
          git diff --cached --quiet || git commit -m "docs: Update architecture diagram [skip ci]"
          git push || echo "Nothing to push"
