# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Diagnostics Workflow - new-12
# Troubleshooting tools for deployment issues
# Generated by Opsera Code-to-Cloud Enterprise v0.912
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: "Diagnostics new-12"

on:
  workflow_dispatch:
    inputs:
      diagnostic_type:
        description: 'Type of diagnostic to run'
        required: true
        default: 'full-pipeline'
        type: choice
        options:
          - 'full-pipeline'
          - 'pod-logs'
          - 'argocd-debug'
          - 'force-sync'

env:
  APP_NAME: new-12
  TENANT: opsera
  AWS_REGION: us-west-2
  ECR_REPOSITORY: opsera/new-12
  ARGOCD_SERVER: argocd-usw2.agent.opsera.dev
  ARGOCD_APP: new-12-dev
  NAMESPACE: opsera-new-12-dev
  SPOKE_CLUSTER: opsera-usw2-np

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Full Pipeline Diagnostics
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  full-diagnostics:
    name: "Full Pipeline Diagnostics"
    runs-on: ubuntu-latest
    if: github.event.inputs.diagnostic_type == 'full-pipeline'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check ECR Repository
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ ECR DIAGNOSTICS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          aws ecr describe-repositories --repository-names "${{ env.ECR_REPOSITORY }}" || echo "âŒ ECR repo not found"
          
          echo ""
          echo "ğŸ“· Recent images:"
          aws ecr describe-images --repository-name "${{ env.ECR_REPOSITORY }}" \
            --query 'imageDetails | sort_by(@, &imagePushedAt) | [-5:].[imageTags[0], imagePushedAt]' \
            --output table 2>/dev/null || echo "No images found"

      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: Check ArgoCD Application
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”„ ARGOCD DIAGNOSTICS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          argocd login ${{ env.ARGOCD_SERVER }} \
            --username admin \
            --password "${{ secrets.ARGOCD_ADMIN_PASSWORD }}" \
            --grpc-web \
            --insecure
          
          echo "ğŸ“‹ Application status:"
          argocd app get ${{ env.ARGOCD_APP }} || echo "âŒ App not found"
          
          echo ""
          echo "ğŸ“œ Application history:"
          argocd app history ${{ env.ARGOCD_APP }} || true
          
          echo ""
          echo "ğŸ”— Cluster status:"
          argocd cluster list

      - name: Check Application Health
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¥ HEALTH CHECK"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          URL="https://opsera-new-12-dev.agent.opsera.dev/health"
          echo "Checking: ${URL}"
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${URL}" --max-time 10 2>/dev/null || echo "000")
          
          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "âœ… Health check passed (HTTP ${HTTP_STATUS})"
          else
            echo "âŒ Health check failed (HTTP ${HTTP_STATUS})"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Pod Logs
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  pod-logs:
    name: "Pod Logs"
    runs-on: ubuntu-latest
    if: github.event.inputs.diagnostic_type == 'pod-logs'
    steps:
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: Get Pod Logs via ArgoCD
        run: |
          argocd login ${{ env.ARGOCD_SERVER }} \
            --username admin \
            --password "${{ secrets.ARGOCD_ADMIN_PASSWORD }}" \
            --grpc-web \
            --insecure
          
          echo "ğŸ“‹ Application resources:"
          argocd app resources ${{ env.ARGOCD_APP }}
          
          echo ""
          echo "ğŸ“œ Getting pod logs..."
          argocd app logs ${{ env.ARGOCD_APP }} --tail 100 || echo "Unable to fetch logs"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ArgoCD Debug
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  argocd-debug:
    name: "ArgoCD Debug"
    runs-on: ubuntu-latest
    if: github.event.inputs.diagnostic_type == 'argocd-debug'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: Debug ArgoCD
        run: |
          argocd login ${{ env.ARGOCD_SERVER }} \
            --username admin \
            --password "${{ secrets.ARGOCD_ADMIN_PASSWORD }}" \
            --grpc-web \
            --insecure
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” ARGOCD DEBUG"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo "ğŸ“‹ Application details:"
          argocd app get ${{ env.ARGOCD_APP }} -o yaml
          
          echo ""
          echo "ğŸ“œ Application manifests:"
          argocd app manifests ${{ env.ARGOCD_APP }} --source live
          
          echo ""
          echo "ğŸ”„ Sync status:"
          argocd app get ${{ env.ARGOCD_APP }} -o json | jq '.status.sync'
          
          echo ""
          echo "ğŸ¥ Health status:"
          argocd app get ${{ env.ARGOCD_APP }} -o json | jq '.status.health'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Force Sync
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  force-sync:
    name: "Force Sync"
    runs-on: ubuntu-latest
    if: github.event.inputs.diagnostic_type == 'force-sync'
    steps:
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: Force Sync Application
        run: |
          argocd login ${{ env.ARGOCD_SERVER }} \
            --username admin \
            --password "${{ secrets.ARGOCD_ADMIN_PASSWORD }}" \
            --grpc-web \
            --insecure
          
          echo "ğŸ”„ Force syncing application..."
          argocd app sync ${{ env.ARGOCD_APP }} --force --prune
          
          echo ""
          echo "â³ Waiting for sync to complete..."
          argocd app wait ${{ env.ARGOCD_APP }} --timeout 300 --health
          
          echo ""
          echo "âœ… Sync complete!"
          argocd app get ${{ env.ARGOCD_APP }}
