name: "Deployment Landscape - hcp-test-0219"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: false
        default: 'uat'
        type: string
      image_tag:
        description: 'Deployed image tag'
        required: false
        type: string
  workflow_call:
    inputs:
      environment:
        required: false
        type: string
        default: 'uat'
      image_tag:
        required: false
        type: string

env:
  APP_NAME: "hcp-test-0219"

jobs:
  landscape:
    name: "Record Deployment"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Write landscape entry
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          LANDSCAPE_DIR=".opsera-hcp-test-0219/landscapes"
          mkdir -p "$LANDSCAPE_DIR"
          cat > "$LANDSCAPE_DIR/latest.md" <<EOF
          # Deployment Landscape: ${{ env.APP_NAME }}
          **Deployed:** $TIMESTAMP
          **Environment:** ${{ inputs.environment || 'uat' }}
          **Image Tag:** ${{ inputs.image_tag || 'N/A' }}
          **URL:** https://${{ env.APP_NAME }}.agent.opsera.dev
          **ArgoCD:** https://argocd-usw2.agent.opsera.dev

          ## Pipeline
          | Job | Status |
          |-----|--------|
          | Bootstrap (Job 0) | ✓ ECR, ArgoCD repo, namespace, SA, ECR secret |
          | Stage 1: Build Image | ✓ |
          | Stage 2: Push to ECR | ✓ ${{ inputs.image_tag || 'N/A' }} |
          | Stage 3: Update Manifests | ✓ |
          | Stage 4: Create ArgoCD App | ✓ |
          | Stage 5: Refresh ECR Secret | ✓ |
          | Stage 6: ArgoCD Sync | ✓ Synced + Healthy |
          | Stage 7: Verify + HTTPS | ✓ https://${{ env.APP_NAME }}.agent.opsera.dev |
          EOF
          git config user.name "opsera-vibe-shift[bot]"
          git config user.email "vibe-shift@opsera.io"
          git stash push -m "landscape-update" -- "$LANDSCAPE_DIR/latest.md"
          git pull --rebase origin main
          git stash pop
          git add "$LANDSCAPE_DIR/latest.md"
          git diff --cached --quiet || git commit -m "chore(landscape): record deployment ${{ inputs.image_tag || '' }} [skip ci]"
          git push origin main || true
          echo "✓ Landscape recorded"

      - name: Publish to S3
        continue-on-error: true
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          aws s3 cp ".opsera-hcp-test-0219/landscapes/latest.md" \
            "s3://opsera-deployment-landscapes/hcp-test-0219/landscapes/$(date +%Y%m%d%H%M%S).md" \
            --region us-west-2 2>/dev/null || true
