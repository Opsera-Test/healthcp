# Reusable deploy workflow (RULE 174): workflow_call + workflow_dispatch. Health check via port-forward (RULE 168).
name: Deploy - healthcp-0209
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options: [dev, qa, staging]
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      image_tag:
        required: false
        type: string
    secrets: inherit
permissions:
  contents: read
  id-token: write
env:
  APP_NAME: healthcp-0209
  TENANT: opsera
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np
jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      KUBECONFIG: /tmp/kubeconfig
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Set env
        id: setenv
        run: echo "namespace=opsera-${{ env.APP_NAME }}-${{ inputs.environment }}" >> $GITHUB_OUTPUT
      - name: Update manifests with image
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${APP_NAME}"
          cd .opsera-${{ env.APP_NAME }}/k8s/overlays/${{ inputs.environment }}
          sed -i "s|PLACEHOLDER_ECR_URI|${ECR_URI}|g" kustomization.yaml *.yaml 2>/dev/null || true
          sed -i "s|newTag:.*|newTag: ${{ inputs.image_tag || 'dev-placeholder' }}|g" kustomization.yaml 2>/dev/null || true
          sed -i "s|image: .*${APP_NAME}:.*|image: ${ECR_URI}:${{ inputs.image_tag || 'dev-placeholder' }}|g" deployment.yaml rollout-canary.yaml rollout-bluegreen.yaml 2>/dev/null || true
      - name: Apply manifests
        run: |
          echo "${{ secrets.KUBECONFIG_SPOKE }}" | base64 -d > $KUBECONFIG
          kubectl apply -k .opsera-${{ env.APP_NAME }}/k8s/overlays/${{ inputs.environment }} -n ${{ steps.setenv.outputs.namespace }}
      - name: Wait for rollout (with degraded grace - RULE 171)
        run: |
          NS=${{ steps.setenv.outputs.namespace }}
          if kubectl get rollout healthcp-0209 -n $NS 2>/dev/null; then
            for i in 1 2 3 4 5 6; do
              STATUS=$(kubectl get rollout healthcp-0209 -n $NS -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
              if [ "$STATUS" = "Degraded" ]; then
                [ $i -ge 6 ] && (kubectl describe rollout healthcp-0209 -n $NS; exit 1) || sleep 10
              else
                break
              fi
            done
            kubectl rollout status rollout/healthcp-0209 -n $NS --timeout=5m || true
          else
            kubectl rollout status deployment/healthcp-0209 -n $NS --timeout=5m || true
          fi
      - name: Health check (port-forward - RULE 168)
        run: |
          NS=${{ steps.setenv.outputs.namespace }}
          POD=$(kubectl get pods -n $NS -l app=healthcp-0209 -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
          [ -z "$POD" ] && echo "No pod found" && exit 1
          kubectl port-forward $POD 8081:8080 -n $NS &
          sleep 3
          wget -qO- http://localhost:8081/health || exit 1
          kill %1 2>/dev/null || true
