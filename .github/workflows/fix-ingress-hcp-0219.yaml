# ════════════════════════════════════════════════════════════════════════════
# Fix Ingress - hcp-0219
# Gets events, describes ingress, patches with annotation, forces reload.
# ════════════════════════════════════════════════════════════════════════════

name: "Fix Ingress - hcp-0219"

on:
  workflow_dispatch: {}

env:
  APP_NAME: hcp-0219
  TENANT: opsera
  ENV: dev
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np

jobs:
  fix-ingress:
    name: "Fix Ingress - diagnose + patch"
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubeconfig (HUB + SPOKE)
        run: |
          aws eks update-kubeconfig --name ${HUB_CLUSTER} --region ${AWS_REGION} --alias hub
          aws eks update-kubeconfig --name ${SPOKE_CLUSTER} --region ${AWS_REGION} --alias spoke

      - name: Describe current ingress state
        run: |
          NS="${TENANT}-${APP_NAME}-${ENV}"
          echo "=== Events in namespace ${NS} ==="
          kubectl --context spoke get events -n ${NS} --sort-by='.lastTimestamp' 2>/dev/null | tail -20
          echo ""
          echo "=== Describe ingress ==="
          kubectl --context spoke describe ingress ${APP_NAME} -n ${NS} 2>/dev/null || echo "Ingress not found"
          echo ""
          echo "=== Ingress YAML ==="
          kubectl --context spoke get ingress ${APP_NAME} -n ${NS} -o yaml 2>/dev/null

      - name: Check service and pods
        run: |
          NS="${TENANT}-${APP_NAME}-${ENV}"
          echo "=== Service ==="
          kubectl --context spoke get svc ${APP_NAME} -n ${NS} -o wide 2>/dev/null
          echo ""
          echo "=== Endpoints ==="
          kubectl --context spoke get endpoints ${APP_NAME} -n ${NS} 2>/dev/null
          echo ""
          echo "=== Pods ==="
          kubectl --context spoke get pods -n ${NS} -o wide 2>/dev/null

      - name: Patch ingress - add kubernetes.io/ingress.class annotation
        run: |
          NS="${TENANT}-${APP_NAME}-${ENV}"
          echo "Patching ingress with kubernetes.io/ingress.class=nginx annotation..."
          kubectl --context spoke annotate ingress ${APP_NAME} -n ${NS} \
            "kubernetes.io/ingress.class=nginx" \
            --overwrite
          echo "✅ Annotation patched"
          sleep 15
          echo "=== Ingress state after patch ==="
          kubectl --context spoke get ingress ${APP_NAME} -n ${NS} -o wide

      - name: Wait and verify ingress gets an address
        run: |
          NS="${TENANT}-${APP_NAME}-${ENV}"
          echo "Waiting for ingress address (up to 3 minutes)..."
          for i in $(seq 1 18); do
            ADDRESS=$(kubectl --context spoke get ingress ${APP_NAME} -n ${NS} \
              -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            HOSTNAME=$(kubectl --context spoke get ingress ${APP_NAME} -n ${NS} \
              -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
            echo "[$i/18] IP: ${ADDRESS:-empty} | Hostname: ${HOSTNAME:-empty}"
            if [ -n "$ADDRESS" ] || [ -n "$HOSTNAME" ]; then
              echo "✅ Ingress address assigned: ${ADDRESS}${HOSTNAME}"
              break
            fi
            sleep 10
          done

      - name: Check nginx ingress controller logs
        run: |
          echo "=== All ingress-nginx pods (SPOKE) ==="
          kubectl --context spoke get pods -n ingress-nginx -o wide 2>/dev/null || true
          echo ""
          echo "=== nginx controller logs (errors + hcp-0219) ==="
          kubectl --context spoke logs -n ingress-nginx \
            -l app.kubernetes.io/name=ingress-nginx \
            --tail=100 2>/dev/null | grep -iE "error|warn|hcp-0219|Sync" | tail -30 || true

      - name: Force ArgoCD hard refresh (HUB)
        run: |
          APP_FULL="${TENANT}-${APP_NAME}-${ENV}"
          echo "Forcing ArgoCD hard refresh for ${APP_FULL}..."
          kubectl --context hub annotate application ${APP_FULL} -n argocd \
            argocd.argoproj.io/refresh=hard --overwrite
          echo "✅ Hard refresh triggered"

      - name: HTTPS URL check
        run: |
          URL="https://${APP_NAME}.agent.opsera.dev"
          echo "Checking: $URL"
          for i in $(seq 1 6); do
            HTTP=$(curl -sLo /dev/null -w "%{http_code}" "$URL" 2>/dev/null || echo "000")
            echo "[$i/6] HTTP $HTTP — $URL"
            [ "$HTTP" -ge 200 ] && [ "$HTTP" -lt 400 ] && echo "✅ App is live!" && break
            sleep 15
          done
