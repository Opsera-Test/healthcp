# Deep diagnostics for hcp-0207 (default backend 404)
# Run with maximum logging to diagnose Ingress/Service/Pod state
name: Diagnostics hcp-0207
on:
  workflow_dispatch:
    inputs:
      log_level:
        description: 'Kubectl log level (0-10)'
        default: '8'
        type: choice
        options: ['6', '8', '10']

env:
  APP_NAME: hcp-0207
  ENV: dev
  AWS_REGION: us-west-2
  NAMESPACE: opsera-hcp-0207-dev
  SPOKE_CLUSTER: opsera-usw2-np
  HUB_CLUSTER: argocd-usw2
  HOSTNAME: opsera-hcp-0207-dev.agent.opsera.dev

permissions:
  contents: read
  id-token: write

jobs:
  diagnose:
    name: Deep diagnostics (max logging)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl (latest)
        run: |
          curl -sLO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          kubectl version --client

      - name: Spoke cluster – namespace and resources
        run: |
          set -x
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          export KUBECONFIG=~/.kube/config
          echo "## Spoke cluster: ${{ env.SPOKE_CLUSTER }}" >> $GITHUB_STEP_SUMMARY
          echo "### Namespace: ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get namespace ${{ env.NAMESPACE }} -o wide 2>&1 || true
          echo "--- ALL IN NAMESPACE ---" >> $GITHUB_STEP_SUMMARY
          kubectl get all,ingress -n ${{ env.NAMESPACE }} -o wide 2>&1 || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Spoke – describe Ingress (verbose)
        run: |
          set -x
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          echo "## Ingress describe (spoke)" >> $GITHUB_STEP_SUMMARY
          echo '```yaml' >> $GITHUB_STEP_SUMMARY
          kubectl describe ingress -n ${{ env.NAMESPACE }} 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get ingress -n ${{ env.NAMESPACE }} -o yaml 2>&1 | head -200

      - name: Spoke – describe Service and Endpoints
        run: |
          set -x
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          echo "## Service & Endpoints (spoke)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl describe svc ${{ env.APP_NAME }} -n ${{ env.NAMESPACE }} 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
          kubectl get endpoints -n ${{ env.NAMESPACE }} 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Spoke – Pods and Deployment (verbose)
        run: |
          set -x
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          echo "## Pods & Deployment (spoke)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl describe deployment ${{ env.APP_NAME }} -n ${{ env.NAMESPACE }} 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
          kubectl describe pods -n ${{ env.NAMESPACE }} -l app=${{ env.APP_NAME }} 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Spoke – Events and Pod logs
        run: |
          set -x
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          echo "## Events (spoke namespace)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get events -n ${{ env.NAMESPACE }} --sort-by='.lastTimestamp' 2>&1 | tail -80 | tee -a $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          for p in $(kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.APP_NAME }} -o name 2>/dev/null); do
            echo "## Logs: $p" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl logs -n ${{ env.NAMESPACE }} $p --tail=100 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          done

      - name: Spoke – All Ingresses in cluster (who receives traffic)
        run: |
          set -x
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          echo "## All Ingresses on spoke (every namespace)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get ingress -A -o wide 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Hub – ArgoCD Application status
        run: |
          set -x
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          echo "## ArgoCD Application hcp-0207-dev (hub)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get application hcp-0207-dev -n argocd -o wide 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
          kubectl describe application hcp-0207-dev -n argocd 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: DNS and cluster endpoints (where does hostname point?)
        run: |
          set -x
          echo "## DNS for ${{ env.HOSTNAME }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          nslookup ${{ env.HOSTNAME }} 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
          dig +short ${{ env.HOSTNAME }} 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "## Spoke cluster endpoint (where our Ingress lives)" >> $GITHUB_STEP_SUMMARY
          aws eks describe-cluster --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }} --query 'cluster.endpoint' --output text 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true

      - name: Summary and recommendation
        run: |
          echo "## Diagnostic summary" >> $GITHUB_STEP_SUMMARY
          echo "Spoke=${{ env.SPOKE_CLUSTER }} | Namespace=${{ env.NAMESPACE }} | Host=${{ env.HOSTNAME }}" >> $GITHUB_STEP_SUMMARY
          echo "Check: (1) Ingress exists and host matches (2) Service has endpoints (3) DNS points to this cluster's Ingress LB" >> $GITHUB_STEP_SUMMARY
