# ════════════════════════════════════════════════════════════════════════════
# CI/CD WORKFLOW - new-15
# Generated by: Opsera Code-to-Cloud Enterprise v0.914
# Builds, scans, and deploys the application via GitOps
# RULE 93: Uses kubectl (NOT argocd CLI) for sync operations
# RULE 147: Gets ECR URI dynamically in each job (avoids secret masking)
# RULE 148: Explicit permissions for git operations
# RULE 143: Pull FIRST, then make changes, then commit/push
# ════════════════════════════════════════════════════════════════════════════
name: 01-CI-Build-Push-new-15

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev

# RULE 148: Explicit permissions required for git push operations
permissions:
  contents: write
  id-token: write
  security-events: write

env:
  APP_NAME: new-15
  AWS_REGION: us-west-2
  TENANT: opsera
  HUB_CLUSTER: opsera-hub-usw2
  SPOKE_CLUSTER: opsera-usw2-np

jobs:
  # ──────────────────────────────────────────────────────────────────────────
  # JOB 1: Security Scan
  # ──────────────────────────────────────────────────────────────────────────
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks (Secrets Detection)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Security Scan Summary
        run: |
          echo "✅ Security scan completed"

  # ──────────────────────────────────────────────────────────────────────────
  # JOB 2: Build and Push to ECR
  # ──────────────────────────────────────────────────────────────────────────
  build-push:
    name: Build & Push to ECR
    runs-on: ubuntu-latest
    needs: security-scan
    outputs:
      image_tag: ${{ steps.vars.outputs.sha_short }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Build Variables
        id: vars
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # RULE 147: Get ECR URI dynamically (avoid secret masking in outputs)
      - name: Get ECR URI
        id: ecr
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.APP_NAME }}"
          echo "uri=${ECR_URI}" >> $GITHUB_OUTPUT
          echo "ECR URI: ${ECR_URI}"

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.ecr.outputs.uri }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Grype Vulnerability Scan
        uses: anchore/scan-action@v3
        id: grype
        with:
          image: ${{ steps.ecr.outputs.uri }}:${{ steps.vars.outputs.sha_short }}
          fail-build: false
          severity-cutoff: critical
        continue-on-error: true

      - name: Build Summary
        run: |
          echo "✅ Image built and pushed: ${{ steps.ecr.outputs.uri }}:${{ steps.vars.outputs.sha_short }}"

  # ──────────────────────────────────────────────────────────────────────────
  # JOB 3: Deploy to Environment
  # ──────────────────────────────────────────────────────────────────────────
  deploy:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: build-push
    environment: dev
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # RULE 147: Get ECR URI dynamically in deploy job too
      - name: Get ECR URI
        id: ecr
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.APP_NAME }}"
          echo "uri=${ECR_URI}" >> $GITHUB_OUTPUT

      # RULE 143: Pull FIRST before making changes
      - name: Pull Latest Changes
        run: |
          git pull --rebase origin main || true

      - name: Update Kustomize Image
        run: |
          cd .opsera-${{ env.APP_NAME }}/k8s/overlays/dev
          
          # Update kustomization.yaml with new image
          cat > kustomization.yaml << 'EOF'
          # ════════════════════════════════════════════════════════════════════════════
          # KUSTOMIZE OVERLAY - dev environment
          # Generated by: Opsera Code-to-Cloud Enterprise v0.914
          # Updated by CI/CD: ${{ github.sha }}
          # ════════════════════════════════════════════════════════════════════════════
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization

          namespace: opsera-new-15-dev

          resources:
            - ../../base
            - namespace.yaml
            - ingress.yaml

          labels:
            - pairs:
                environment: dev
                tenant: opsera
              includeSelectors: false

          images:
            - name: IMAGE_PLACEHOLDER
              newName: ${{ steps.ecr.outputs.uri }}
              newTag: "${{ needs.build-push.outputs.image_tag }}"

          replicas:
            - name: new-15
              count: 1
          EOF
          
          echo "✅ Updated kustomization.yaml with image tag: ${{ needs.build-push.outputs.image_tag }}"

      - name: Commit and Push Changes
        run: |
          git add .opsera-${{ env.APP_NAME }}/k8s/overlays/dev/kustomization.yaml
          git diff --staged --quiet || git commit -m "deploy(${{ env.APP_NAME }}): update image to ${{ needs.build-push.outputs.image_tag }} [skip ci]"
          git push origin main || (git pull --rebase origin main && git push origin main)

      - name: Configure kubectl for Hub Cluster
        run: |
          aws eks update-kubeconfig \
            --name ${{ env.HUB_CLUSTER }} \
            --region ${{ env.AWS_REGION }}

      # RULE 93: Use kubectl to trigger ArgoCD sync (NOT argocd CLI)
      - name: Trigger ArgoCD Sync
        run: |
          # Ensure ArgoCD application exists
          kubectl apply -f .opsera-${{ env.APP_NAME }}/argocd/dev/application.yaml -n argocd
          
          # Trigger refresh
          kubectl annotate application ${{ env.APP_NAME }}-dev -n argocd \
            argocd.argoproj.io/refresh=hard --overwrite || true
          
          echo "✅ ArgoCD sync triggered for ${{ env.APP_NAME }}-dev"

      - name: Deployment Summary
        run: |
          echo ""
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║                    DEPLOYMENT COMPLETE                           ║"
          echo "╠══════════════════════════════════════════════════════════════════╣"
          echo "║  App:        ${{ env.APP_NAME }}"
          echo "║  Environment: dev"
          echo "║  Image Tag:  ${{ needs.build-push.outputs.image_tag }}"
          echo "║  Endpoint:   https://opsera-new-15-dev.agent.opsera.dev"
          echo "║                                                                  ║"
          echo "║  ArgoCD:     https://argocd-usw2.agent.opsera.dev               ║"
          echo "╚══════════════════════════════════════════════════════════════════╝"
