# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HEALTHCP: Install Argo Rollouts
# Required for Canary (QA) and Blue-Green (Staging) deployments
# Generated by Opsera Code-to-Cloud Enterprise v1.4
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ”„ Install Argo Rollouts"

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  WORKLOAD_CLUSTER: opsera-use1-np

jobs:
  install-argo-rollouts:
    name: "ðŸ”„ Install Argo Rollouts"
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.WORKLOAD_CLUSTER }} --region ${{ env.AWS_REGION }}
          kubectl cluster-info
          echo "âœ… Connected to cluster: ${{ env.WORKLOAD_CLUSTER }}" >> $GITHUB_STEP_SUMMARY

      - name: Install Argo Rollouts CRDs
        run: |
          echo "### ðŸ“¦ Installing Argo Rollouts" >> $GITHUB_STEP_SUMMARY
          
          # Create namespace
          kubectl create namespace argo-rollouts --dry-run=client -o yaml | kubectl apply -f -
          
          # Install Argo Rollouts
          kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml
          
          # Wait for controller to be ready
          echo "Waiting for Argo Rollouts controller..."
          kubectl wait --for=condition=available deployment/argo-rollouts -n argo-rollouts --timeout=120s || true
          
          echo "âœ… Argo Rollouts installed" >> $GITHUB_STEP_SUMMARY

      - name: Install Argo Rollouts kubectl plugin
        run: |
          # Install kubectl-argo-rollouts plugin
          curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
          chmod +x kubectl-argo-rollouts-linux-amd64
          sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts
          
          echo "âœ… kubectl-argo-rollouts plugin installed" >> $GITHUB_STEP_SUMMARY

      - name: Verify Installation
        run: |
          echo "### ðŸ” Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check CRDs
          echo "**Custom Resource Definitions:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get crd | grep argoproj >> $GITHUB_STEP_SUMMARY || echo "No Argo CRDs found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Check pods
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Argo Rollouts Pods:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n argo-rollouts >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ‰ Argo Rollouts Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "You can now deploy with:" >> $GITHUB_STEP_SUMMARY
          echo "- **Canary** (QA): Gradual traffic shifting 10%â†’30%â†’60%â†’100%" >> $GITHUB_STEP_SUMMARY
          echo "- **Blue-Green** (Staging): Instant traffic switch with preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Step:** Re-run the QA deployment workflow" >> $GITHUB_STEP_SUMMARY
