# healthcp - CI/CD Setup Guide

> Generated by Opsera Code-to-Cloud Enterprise v1.4

## Overview

This document provides step-by-step instructions for setting up the CI/CD pipeline for healthcp.

### Configuration Summary

| Setting | Value |
|---------|-------|
| **Application** | healthcp |
| **Cloud Provider** | AWS |
| **Region** | us-east-1 |
| **Environments** | DEV → QA → Staging |
| **Promotion** | Manual |

### Deployment Strategies

| Environment | Strategy | Description |
|-------------|----------|-------------|
| DEV | Rolling | Simple, fast deployments |
| QA | Canary | 10% → 30% → 60% → 100% with analysis |
| Staging | Blue-Green | Instant switch, instant rollback |

---

## Prerequisites

- AWS CLI configured with appropriate permissions
- GitHub CLI (`gh`) installed
- kubectl installed
- Terraform >= 1.0 (optional, for infrastructure provisioning)

---

## Step 1: Infrastructure Setup

### Option A: Use Existing EKS Cluster

If you have an existing EKS cluster, configure kubectl:

```bash
aws eks update-kubeconfig --name YOUR_CLUSTER_NAME --region us-east-1
```

### Option B: Create New Infrastructure with Terraform

```bash
cd .opsera-healthcp/terraform

# Initialize Terraform
terraform init

# Review the plan
terraform plan

# Apply (creates VPC, EKS, ECR, IAM roles)
terraform apply
```

After Terraform completes, note the outputs for GitHub secrets.

---

## Step 2: Configure GitHub Secrets

Add these secrets to your GitHub repository:

```bash
# Required Secrets
gh secret set AWS_ROLE_ARN --body "arn:aws:iam::ACCOUNT_ID:role/healthcp-github-actions-role"

# Optional: Slack Integration
gh secret set SLACK_WEBHOOK_URL --body "https://hooks.slack.com/services/..."

# Optional: Jira Integration
gh secret set JIRA_API_TOKEN --body "your-jira-api-token"
gh secret set JIRA_EMAIL --body "your-email@company.com"
gh secret set JIRA_BASE_URL --body "https://your-company.atlassian.net"

# Optional: SonarQube
gh secret set SONAR_TOKEN --body "your-sonar-token"
gh secret set SONAR_HOST_URL --body "https://sonarqube.example.com"

# Optional: NewRelic
gh secret set NEWRELIC_API_KEY --body "your-newrelic-api-key"
```

---

## Step 3: Configure GitHub Variables

```bash
gh variable set AWS_REGION --body "us-east-1"
gh variable set ROUTE53_HOSTED_ZONE_ID --body "Z1234567890ABC"  # Your hosted zone
gh variable set SLACK_CHANNEL --body "#deployments"
```

---

## Step 4: Install ArgoCD and Argo Rollouts

### Install ArgoCD

```bash
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```

### Install Argo Rollouts

```bash
kubectl create namespace argo-rollouts
kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml
```

### Install NGINX Ingress Controller

```bash
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.9.4/deploy/static/provider/aws/deploy.yaml
```

### Install cert-manager

```bash
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
```

---

## Step 5: Register ArgoCD Applications

```bash
# Apply ArgoCD application manifests
kubectl apply -f .opsera-healthcp/argocd/dev.yaml
kubectl apply -f .opsera-healthcp/argocd/qa.yaml
kubectl apply -f .opsera-healthcp/argocd/staging.yaml
```

---

## Step 6: Create ECR Repository (if not using Terraform)

```bash
aws ecr create-repository --repository-name healthcp --region us-east-1
```

---

## Step 7: Verify Setup

### Check ArgoCD Applications

```bash
kubectl get applications -n argocd
```

### Check Namespaces

```bash
kubectl get namespaces | grep healthcp
```

---

## Usage

### Automatic Deployment (DEV)

Push to `main` branch triggers automatic deployment to DEV:

```bash
git add .
git commit -m "feat: new feature"
git push origin main
```

### Manual Promotion to QA

```bash
gh workflow run ci-build-push-healthcp.yaml \
  -f environment=qa \
  -f image_tag=<IMAGE_TAG_FROM_DEV>
```

### Manual Promotion to Staging

```bash
gh workflow run ci-build-push-healthcp.yaml \
  -f environment=staging \
  -f image_tag=<IMAGE_TAG_FROM_QA>
```

---

## Troubleshooting

### Run Diagnostics

```bash
# Full pipeline diagnostics
gh workflow run diagnostics-healthcp.yaml \
  -f environment=dev \
  -f diagnostic_type=full-pipeline

# Get pod logs
gh workflow run diagnostics-healthcp.yaml \
  -f environment=qa \
  -f diagnostic_type=pod-logs

# Force ArgoCD sync
gh workflow run diagnostics-healthcp.yaml \
  -f environment=staging \
  -f diagnostic_type=force-sync
```

### Common Issues

| Issue | Solution |
|-------|----------|
| ImagePullBackOff | Verify ECR permissions and image tag exists |
| ArgoCD OutOfSync | Run force-sync diagnostic |
| Canary timeout | Check analysis template and increase timeout |
| DNS not resolving | Verify Route53 hosted zone ID and permissions |

---

## File Structure

```
.opsera-healthcp/
├── argocd/
│   ├── dev.yaml
│   ├── qa.yaml
│   └── staging.yaml
├── k8s/
│   ├── base/
│   │   ├── deployment.yaml
│   │   ├── ingress.yaml
│   │   ├── kustomization.yaml
│   │   └── service.yaml
│   └── overlays/
│       ├── dev/
│       │   ├── kustomization.yaml
│       │   └── namespace.yaml
│       ├── qa/
│       │   ├── analysis-template.yaml
│       │   ├── kustomization.yaml
│       │   ├── namespace.yaml
│       │   ├── rollout.yaml
│       │   └── services.yaml
│       └── staging/
│           ├── analysis-template.yaml
│           ├── kustomization.yaml
│           ├── namespace.yaml
│           ├── rollout.yaml
│           └── services.yaml
├── terraform/
│   ├── main.tf
│   └── outputs.tf
└── docs/
    ├── architecture.md
    └── SETUP.md

.github/workflows/
├── ci-build-push-healthcp.yaml      # Main CI/CD workflow
├── quality-gates-healthcp.yaml      # Security scanning
├── diagnostics-healthcp.yaml        # Troubleshooting
└── architecture-healthcp.yaml       # Architecture docs
```

---

## Support

For issues or questions, run the diagnostics workflow or check the GitHub Actions logs.

---

*Generated by Opsera Code-to-Cloud Enterprise v1.4*
