# ════════════════════════════════════════════════════════════════════════════
# QA ANALYSIS TEMPLATE - Health checks for canary deployments
# RULE 44: Must be in each overlay kustomization.yaml
# RULE 46: Use Job provider for secrets access
# Generated by Opsera Code-to-Cloud Enterprise v1.4
# ════════════════════════════════════════════════════════════════════════════
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: http-success-rate
  namespace: healthcp-qa
spec:
  args:
    - name: service-name
  metrics:
    - name: success-rate
      interval: 30s
      count: 5
      failureLimit: 2
      successCondition: result >= 0.95
      provider:
        job:
          spec:
            backoffLimit: 1
            template:
              spec:
                restartPolicy: Never
                containers:
                  - name: health-checker
                    image: curlimages/curl:latest
                    env:
                      - name: SERVICE_NAME
                        value: "{{args.service-name}}"
                      - name: NR_API_KEY
                        valueFrom:
                          secretKeyRef:
                            name: newrelic-api-key
                            key: api-key
                            optional: true
                    command:
                      - /bin/sh
                      - -c
                      - |
                        # Check if NewRelic is configured
                        if [ -z "$NR_API_KEY" ]; then
                          echo "NewRelic not configured - using basic health check"
                          # Basic health check fallback (using / as Vite app has no /health endpoint)
                          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${SERVICE_NAME}.healthcp-qa.svc.cluster.local/)
                          if [ "$RESPONSE" = "200" ]; then
                            echo "1.0"
                          else
                            echo "0.0"
                          fi
                        else
                          # NewRelic APM query would go here
                          echo "1.0"
                        fi
